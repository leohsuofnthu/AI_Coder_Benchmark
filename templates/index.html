<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Coder Evaluation</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            /* Primary Colors - Elegant Blues */
            --primary-color: #4f8df5;
            --primary-light: #7ba6f8;
            --primary-dark: #3a6fd8;
            
            /* Success - Soft Emerald */
            --success-color: #10b981;
            --success-light: #34d399;
            --success-dark: #059669;
            
            /* Warning - Softer Amber */
            --warning-color: #f2b266; /* softened */
            --warning-light: #f6cf8f;
            --warning-dark: #d7923e;
            
            /* Danger - Muted Coral */
            --danger-color: #f17373; /* softened */
            --danger-light: #f6a2a2;
            --danger-dark: #e44747;
            
            /* Accent - Elegant Purple */
            --accent-purple: #8b5cf6;
            --accent-purple-light: #a78bfa;
            --accent-indigo: #6366f1;
            
            /* Background - Deep Navy */
            --dark-bg: #0f172a;
            --card-bg: #1e293b;
            --card-border: #334155;
            --surface-bg: #172033;
            
            /* Text - Soft Grays */
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            
            /* Accent Blue */
            --accent-blue: #60a5fa;
            --accent-blue-light: #93c5fd;
        }
        
        body {
            background: var(--dark-bg);
            min-height: 100vh;
            font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            color: var(--text-primary);
        }

        /* Dark grid table styling for better contrast */
        .table-dark-grid thead th {
            background: var(--surface-bg) !important;
            color: var(--text-primary) !important;
            border-bottom: 1px solid var(--card-border) !important;
        }
        .table-dark-grid tbody td {
            background: var(--card-bg) !important;
            color: var(--text-primary) !important;
            border-top: 1px solid var(--surface-bg) !important;
        }
        .table-dark-grid tbody tr:hover td {
            background: rgba(255, 255, 255, 0.02) !important;
        }
        
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        @media (max-width: 768px) {
            .main-container {
                padding: 1rem;
            }
            
            .results-header h2 {
                font-size: 1.5rem;
            }
            
            .section-title {
                font-size: 1.125rem;
            }
            
            .metric-value {
                font-size: 2rem;
            }
            
            .metric-icon-wrapper {
                width: 48px;
                height: 48px;
            }
            
            .metric-icon-wrapper i {
                font-size: 1.5rem !important;
            }
            
            .download-card {
                padding: 1.5rem;
            }
            
            .chart-wrapper {
                height: 250px;
            }
        }
        
        .header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem 0;
            border-bottom: 1px solid var(--card-border);
            animation: fadeInDown 0.6s;
        }
        
        .header h1 {
            font-size: 2.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            letter-spacing: -0.025em;
        }
        
        .header p {
            font-size: 1rem;
            color: var(--text-secondary);
            font-weight: 400;
        }
        
        .upload-section {
            background: var(--card-bg);
            border-radius: 0.75rem;
            padding: 2.5rem;
            border: 1px solid var(--card-border);
            margin-bottom: 2rem;
            animation: fadeInUp 0.6s;
        }
        
        .upload-section h2, .upload-section h3 {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1.125rem;
            letter-spacing: -0.025em;
        }
        
        .upload-area {
            border: 2px dashed var(--card-border);
            border-radius: 0.75rem;
            padding: 3rem;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            background: var(--surface-bg);
        }
        
        .upload-area:hover, .upload-area.dragover {
            border-color: var(--primary-color);
            background: rgba(59, 130, 246, 0.05);
            transform: translateY(-2px);
        }
        
        .upload-area i {
            font-size: 3rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }
        
        .upload-area h4 {
            color: var(--text-primary);
            font-weight: 500;
        }
        
        .upload-area p {
            color: var(--text-muted);
        }
        
        .benchmark-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        
        .benchmark-card {
            background: var(--surface-bg);
            border: 1px solid var(--card-border);
            border-radius: 0.5rem;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .benchmark-card h5 {
            color: var(--text-primary);
            font-weight: 500;
        }
        
        .benchmark-card p {
            color: var(--text-muted);
        }
        
        .benchmark-card:hover {
            transform: translateY(-2px);
            border-color: var(--primary-color);
            background: rgba(59, 130, 246, 0.05);
        }
        
        .benchmark-card.selected {
            border-color: var(--primary-color);
            background: rgba(59, 130, 246, 0.1);
            box-shadow: 0 0 0 1px var(--primary-color);
        }
        
        .btn-evaluate {
            background: var(--primary-color);
            border: none;
            padding: 0.875rem 2.5rem;
            font-size: 0.95rem;
            font-weight: 500;
            border-radius: 0.5rem;
            transition: all 0.2s;
            letter-spacing: 0.025em;
        }
        
        .btn-evaluate:hover:not(:disabled) {
            background: #2563eb;
            transform: translateY(-1px);
        }
        
        .btn-evaluate:disabled {
            background: var(--card-border);
            color: var(--text-muted);
            cursor: not-allowed;
        }
        
        .results-section {
            display: none;
            animation: fadeInUp 0.6s;
        }
        
        .results-section h2 {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1.25rem;
            letter-spacing: -0.025em;
        }
        
        /* Results Section */
        .results-section {
            display: none;
        }
        
        .results-section.active {
            display: block;
            animation: fadeInUp 0.6s;
        }
        
        .results-header {
            padding-bottom: 1.5rem;
            border-bottom: 2px solid var(--card-border);
        }
        
        .results-header h2 {
            font-size: 2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        
        /* Section Groups */
        .section-group {
            margin-bottom: 3rem;
        }
        
        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--card-border);
            margin-bottom: 1.5rem;
        }
        
        /* Metric Cards */
        .metric-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 0.75rem;
            padding: 1.75rem 1.5rem;
            transition: all 0.3s ease;
            height: 100%;
            position: relative;
            overflow: hidden;
        }
        
        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--success-color));
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-4px);
            border-color: var(--primary-color);
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.15);
        }
        
        .metric-card:hover::before {
            opacity: 1;
        }
        
        .metric-card.metric-primary {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(34, 197, 94, 0.05) 100%);
            border: 1.5px solid var(--card-border);
        }
        
        .metric-card.metric-primary:hover {
            border-color: var(--primary-color);
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.12) 0%, rgba(34, 197, 94, 0.08) 100%);
        }
        
        .metric-icon-wrapper {
            width: 64px;
            height: 64px;
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        
        .metric-card:hover .metric-icon-wrapper {
            transform: scale(1.1);
            background: rgba(59, 130, 246, 0.2);
        }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0.75rem 0;
            letter-spacing: -0.025em;
            line-height: 1.2;
        }
        
        .metric-label {
            color: var(--text-secondary);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .metric-card small {
            color: var(--text-muted);
            font-size: 0.75rem;
        }
        
        .metric-excellent { color: var(--success-color); }
        .metric-good { color: var(--primary-light); }
        .metric-fair { color: var(--warning-color); }
        .metric-poor { color: var(--danger-color); }
        
        /* Chart Containers */
        .chart-container {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 0.75rem;
            padding: 2rem;
            transition: all 0.3s ease;
            height: 100%;
        }
        
        .chart-container:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
        }
        
        .chart-container h4 {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1.125rem;
        }
        
        .chart-wrapper {
            position: relative;
            height: 300px;
            margin-top: 1rem;
        }
        
        /* Code Tables */
        .code-table {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 0.75rem;
            padding: 2rem;
            max-height: 500px;
            overflow-y: auto;
            transition: all 0.3s ease;
        }
        
        .code-table:hover {
            border-color: var(--primary-color);
        }
        
        .code-table h4 {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1.125rem;
        }
        
        .code-table .border-bottom {
            border-color: var(--card-border) !important;
        }
        
        .code-table.mismatch-details {
            max-height: none;
        }
        
        .mismatch-list {
            max-height: 600px;
            overflow-y: auto;
            padding: 0.5rem 0;
        }
        
        .mismatch-list::-webkit-scrollbar,
        .code-table::-webkit-scrollbar {
            width: 8px;
        }
        
        .mismatch-list::-webkit-scrollbar-track,
        .code-table::-webkit-scrollbar-track {
            background: var(--surface-bg);
            border-radius: 4px;
        }
        
        .mismatch-list::-webkit-scrollbar-thumb,
        .code-table::-webkit-scrollbar-thumb {
            background: var(--card-border);
            border-radius: 4px;
        }
        
        .mismatch-list::-webkit-scrollbar-thumb:hover,
        .code-table::-webkit-scrollbar-thumb:hover {
            background: var(--primary-color);
        }
        
        /* Error Container */
        .error-container {
            animation: fadeInUp 0.4s ease;
            background: var(--card-bg);
            border: 2px solid var(--danger-color);
            border-radius: 0.75rem;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .error-container .error-icon {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .error-message pre {
            background: rgba(248, 113, 113, 0.08);
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 3px solid var(--danger-color);
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin: 0.5rem 0;
        }
        
        /* Download Card */
        .download-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(34, 197, 94, 0.1) 100%);
            border: 2px solid var(--primary-color);
            border-radius: 0.75rem;
            padding: 2rem;
            transition: all 0.3s ease;
            animation: fadeInUp 0.6s;
        }
        
        .download-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(59, 130, 246, 0.2);
            border-color: var(--success-color);
        }
        
        .download-icon-wrapper {
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--success-color), #16a34a);
            border-radius: 12px;
            color: white;
        }
        
        .download-card .btn-success {
            background: linear-gradient(135deg, var(--success-color) 0%, var(--success-dark) 100%);
            border: none;
            transition: all 0.3s ease;
            padding: 0.875rem 2rem;
            font-weight: 600;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }
        
        .download-card .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(34, 197, 94, 0.4);
        }
        
        .download-card .btn-success:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 14, 26, 0.95);
            backdrop-filter: blur(4px);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .loading-overlay h3 {
            color: var(--text-primary);
        }
        
        .loading-overlay p {
            color: var(--text-secondary);
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--card-border);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .badge {
            font-weight: 500;
            font-size: 0.75rem;
        }
        
        .badge-depth-1 { background: rgba(239, 68, 68, 0.15); color: #fca5a5; border: 1px solid rgba(239, 68, 68, 0.3); }
        .badge-depth-2 { background: rgba(245, 158, 11, 0.15); color: #fcd34d; border: 1px solid rgba(245, 158, 11, 0.3); }
        .badge-depth-3 { background: rgba(59, 130, 246, 0.15); color: #93c5fd; border: 1px solid rgba(59, 130, 246, 0.3); }
        .badge-depth-4 { background: rgba(34, 197, 94, 0.15); color: #86efac; border: 1px solid rgba(34, 197, 94, 0.3); }
        
        .badge-primary {
            background: rgba(59, 130, 246, 0.15);
            color: var(--accent-blue);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        .badge-secondary {
            background: rgba(107, 114, 128, 0.15);
            color: var(--text-secondary);
            border: 1px solid var(--card-border);
        }
        
        .bg-success {
            background: rgba(34, 197, 94, 0.15) !important;
            color: #86efac !important;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        
        .bg-warning {
            background: rgba(245, 158, 11, 0.15) !important;
            color: #fcd34d !important;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .bg-danger {
            background: rgba(239, 68, 68, 0.15) !important;
            color: #fca5a5 !important;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .alert-custom {
            border-radius: 0.75rem;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
        }
        
        .alert-danger {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            color: var(--text-primary);
        }
        
        .text-muted {
            color: var(--text-muted) !important;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="text-center">
            <div class="spinner mb-3"></div>
            <h3>Evaluating Model...</h3>
            <p>Processing validation and metrics calculation</p>
        </div>
    </div>

    <div class="main-container">
        <!-- Header -->
        <div class="header">
            <h1>AI Coder Evaluation Platform</h1>
            <p>Multi-label classification evaluation for response coding models</p>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation mb-4">
            <div class="nav nav-tabs" role="tablist" style="border-bottom: 2px solid var(--card-border);">
                <button class="nav-link active" id="codeAssignmentTab" data-bs-toggle="tab" data-bs-target="#codeAssignment" type="button" role="tab" style="background: transparent; border: none; color: var(--text-primary); padding: 1rem 2rem; font-weight: 500; cursor: pointer;">
                    <i class="fas fa-code me-2"></i>Code Assignment
                </button>
                <button class="nav-link" id="hierarchyTab" data-bs-toggle="tab" data-bs-target="#hierarchy" type="button" role="tab" style="background: transparent; border: none; color: var(--text-secondary); padding: 1rem 2rem; font-weight: 500; cursor: pointer;">
                    <i class="fas fa-sitemap me-2"></i>Hierarchy Evaluation
                </button>
            </div>
        </div>

        <!-- Tab Content -->
        <div class="tab-content">
            <!-- Code Assignment Tab -->
            <div class="tab-pane fade show active" id="codeAssignment" role="tabpanel">
        <!-- Upload Section -->
        <div class="upload-section">
            <h2 class="mb-4"><i class="fas fa-upload me-2"></i>Upload Model Output</h2>
            
            <!-- Drag & Drop Area -->
            <div class="upload-area" id="uploadArea">
                <i class="fas fa-cloud-upload-alt"></i>
                <h4>Drag & Drop XML File Here</h4>
                <p class="text-muted">or click to browse</p>
                <input type="file" id="fileInput" accept=".xml" style="display: none;">
                <div id="fileInfo" class="mt-3" style="display: none;">
                    <span class="badge bg-primary fs-6">
                        <i class="fas fa-file-code me-2"></i><span id="fileName"></span>
                    </span>
                </div>
            </div>

            <!-- Benchmark Selection -->
            <h3 class="mt-5 mb-3"><i class="fas fa-database me-2"></i>Select Benchmark</h3>
            <div class="benchmark-grid" id="benchmarkGrid">
                {% for id, benchmark in benchmarks.items() %}
                <div class="benchmark-card" data-benchmark="{{ id }}">
                    <h5 class="mb-2">
                        <i class="fas fa-file-alt me-2"></i>{{ benchmark.name }}
                    </h5>
                    <p class="text-muted mb-2" style="font-size: 0.9rem;">{{ benchmark.description }}</p>
                    <small class="badge bg-secondary">{{ benchmark.size }}</small>
                </div>
                {% endfor %}
            </div>

            <!-- Evaluate Button -->
            <div class="text-center mt-4">
                <button class="btn btn-evaluate text-white" id="evaluateBtn" disabled>
                    <i class="fas fa-chart-line me-2"></i>Evaluate Model
                </button>
            </div>
        </div>

        <!-- Results Section -->
        <div class="results-section" id="resultsSection">
            <!-- Results Header -->
            <div class="results-header mb-5">
                <h2 class="mb-2"><i class="fas fa-chart-bar me-2"></i>Evaluation Results</h2>
                <p class="text-muted mb-0">
                    Comprehensive performance metrics and detailed analysis
                    <br><small><i class="fas fa-info-circle me-1"></i><strong>Note:</strong> Only open-ended questions (QuestionType = 0) are analyzed</small>
                </p>
            </div>

            <!-- Main Evaluation: Coding Quality (When Benchmark Has Codes) -->
            <div class="section-group mb-5">
                <h3 class="section-title mb-4">
                    <i class="fas fa-star me-2" style="color: var(--warning-light);"></i>Model Coding Performance
                </h3>
                <div class="alert alert-info mb-4" style="background: rgba(79, 141, 245, 0.08); border-left: 3px solid var(--primary-color); border-radius: 0.5rem;">
                    <i class="fas fa-info-circle me-2" style="color: var(--primary-light);"></i>
                    <strong style="color: var(--text-primary);">Primary Evaluation:</strong> 
                    <span style="color: var(--text-secondary);">Metrics below evaluate model performance <strong>only for responses where the benchmark has codes assigned</strong>.
                    This measures how accurately the model codes responses that should have codes.</span>
                </div>
                <div class="row g-4">
                    <div class="col-lg-3 col-md-6">
                        <div class="metric-card metric-primary text-center">
                            <div class="metric-icon-wrapper">
                                <i class="fas fa-bullseye fa-2x" style="color: var(--primary-light);"></i>
                            </div>
                            <div class="metric-label">F1-Score</div>
                            <div class="metric-value" id="f1Micro">-</div>
                            <small class="text-muted" id="f1MicroLabel">Micro-averaged</small>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="metric-card metric-primary text-center">
                            <div class="metric-icon-wrapper">
                                <i class="fas fa-crosshairs fa-2x" style="color: var(--success-light);"></i>
                            </div>
                            <div class="metric-label">Precision</div>
                            <div class="metric-value" id="precision">-</div>
                            <small class="text-muted">Micro-averaged</small>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="metric-card metric-primary text-center">
                            <div class="metric-icon-wrapper">
                                <i class="fas fa-clipboard-check fa-2x" style="color: var(--primary-light);"></i>
                            </div>
                            <div class="metric-label">Recall</div>
                            <div class="metric-value" id="recall">-</div>
                            <small class="text-muted">Micro-averaged</small>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="metric-card metric-primary text-center">
                            <div class="metric-icon-wrapper">
                                <i class="fas fa-check-double fa-2x" style="color: var(--warning-light);"></i>
                            </div>
                            <div class="metric-label">Exact Match</div>
                            <div class="metric-value" id="exactMatch">-</div>
                            <small class="text-muted">Perfect predictions</small>
                        </div>
                    </div>
                </div>
                
                <!-- Secondary Row - Additional Context -->
                <div class="row g-4 mt-3">
                    <div class="col-lg-4 col-md-6">
                        <div class="metric-card text-center" style="border-left: 3px solid var(--text-muted);">
                            <div class="metric-icon-wrapper">
                                <i class="fas fa-project-diagram fa-2x" style="color: var(--text-muted);"></i>
                            </div>
                            <div class="metric-label">Jaccard Similarity</div>
                            <div class="metric-value" id="jaccard">-</div>
                            <small class="text-muted">Average overlap</small>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-6">
                        <div class="metric-card text-center" style="border-left: 3px solid var(--text-muted);">
                            <div class="metric-icon-wrapper">
                                <i class="fas fa-list-ol fa-2x" style="color: var(--text-muted);"></i>
                            </div>
                            <div class="metric-label">Coded Responses</div>
                            <div class="metric-value" id="nCodedResponses">-</div>
                            <small class="text-muted">Where benchmark has codes</small>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-6">
                        <div class="metric-card text-center" style="border-left: 3px solid var(--text-muted);">
                            <div class="metric-icon-wrapper">
                                <i class="fas fa-layer-group fa-2x" style="color: var(--text-muted);"></i>
                            </div>
                            <div class="metric-label">F1-Score (Macro)</div>
                            <div class="metric-value" id="f1Macro">-</div>
                            <small class="text-muted">Per-code average</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Uncoded Classification Performance (Separate Evaluation) -->
            <div class="section-group mb-5" id="uncodedClassificationSection" style="display: none;">
                <h3 class="section-title mb-4">
                    <i class="fas fa-question-circle me-2" style="color: var(--warning-light);"></i>Uncoded Classification Performance
                </h3>
                <div class="alert alert-warning mb-4" style="background: rgba(245, 158, 11, 0.08); border-left: 3px solid var(--warning-color); border-radius: 0.5rem;">
                    <i class="fas fa-info-circle me-2" style="color: var(--warning-light);"></i>
                    <strong style="color: var(--text-primary);">Separate Evaluation:</strong> 
                    <span style="color: var(--text-secondary);">This measures how well the model identifies when responses should have <strong>no codes assigned</strong>.
                    This is evaluated separately from coding quality above.</span>
                </div>
                <div class="row g-4">
                    <div class="col-lg-3 col-md-6">
                        <div class="metric-card text-center" style="border-left: 4px solid var(--success-color);">
                            <div class="metric-icon-wrapper">
                                <i class="fas fa-check-circle fa-2x" style="color: var(--success-light);"></i>
                            </div>
                            <div class="metric-label">Overlap</div>
                            <div class="metric-value" id="uncodedOverlapCount">0</div>
                            <small class="text-muted" id="uncodedOverlapPct">0%</small>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="metric-card text-center" style="border-left: 4px solid var(--primary-color);">
                            <div class="metric-icon-wrapper">
                                <i class="fas fa-bullseye fa-2x" style="color: var(--primary-light);"></i>
                            </div>
                            <div class="metric-label">Classification Accuracy</div>
                            <div class="metric-value" id="uncodedClassificationAccuracy">-</div>
                            <small class="text-muted">Correctly identified as uncoded</small>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="metric-card text-center" style="border-left: 4px solid var(--danger-color);">
                            <div class="metric-icon-wrapper">
                                <i class="fas fa-exclamation-triangle fa-2x" style="color: var(--danger-light);"></i>
                            </div>
                            <div class="metric-label">Incorrectly Coded</div>
                            <div class="metric-value" id="incorrectlyCodedCount">0</div>
                            <small class="text-muted">Model coded when shouldn't</small>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="metric-card text-center" style="border-left: 4px solid var(--warning-color);">
                            <div class="metric-icon-wrapper">
                                <i class="fas fa-file-alt fa-2x" style="color: var(--warning-light);"></i>
                            </div>
                            <div class="metric-label">Benchmark Uncoded</div>
                            <div class="metric-value" id="uncodedBenchmarkTotal">0</div>
                            <small class="text-muted">Total uncoded cases</small>
                        </div>
                    </div>
                </div>
                
                <!-- Show examples of incorrectly coded responses -->
                <div id="incorrectlyCodedExamples" class="mt-4" style="display: none;">
                    <h5 class="mb-3" style="color: var(--text-primary);">
                        <i class="fas fa-list me-2"></i>Examples: Responses Incorrectly Coded (Model assigned codes when benchmark is uncoded)
                    </h5>
                    <div class="table-responsive">
                        <table class="table table-sm" style="background: var(--card-bg); font-size: 0.9rem;">
                            <thead style="background: rgba(248, 113, 113, 0.08);">
                                <tr>
                                    <th>Respondent ID</th>
                                    <th>Question ID</th>
                                    <th>Assigned Codes</th>
                                    <th>Count</th>
                                </tr>
                            </thead>
                            <tbody id="incorrectlyCodedTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Question-Level Uncoded Breakdown Section -->
            <div class="section-group mb-5" id="questionUncodedSection" style="display: none;">
                <h3 class="section-title mb-4">
                    <i class="fas fa-table me-2" style="color: var(--accent-indigo);"></i>Question-Level Uncoded Breakdown
                </h3>
                <div class="alert alert-info mb-3" style="background: rgba(99, 102, 241, 0.08); border-left: 3px solid var(--accent-indigo); border-radius: 0.5rem;">
                    <i class="fas fa-info-circle me-2" style="color: var(--accent-purple-light);"></i>
                    <strong style="color: var(--text-primary);">Overlap Analysis:</strong> 
                    <span style="color: var(--text-secondary);">Shows how many responses are uncoded in both benchmark and model output for each question.
                    Higher overlap indicates better agreement on which responses should remain uncoded.</span>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover table-dark-grid" style="background: var(--card-bg); border-radius: 0.5rem; overflow: hidden; border-collapse: separate; border-spacing: 0;">
                        <thead style="border-bottom: 2px solid var(--card-border);">
                            <tr>
                                <th style="color: var(--text-secondary); font-weight: 700; padding: 1rem 0.75rem; font-size: 0.875rem; letter-spacing: 0.025em; text-transform: uppercase;">Question ID</th>
                                <th style="color: var(--text-secondary); font-weight: 700; padding: 1rem 0.75rem; font-size: 0.875rem; letter-spacing: 0.025em; text-transform: uppercase;" class="text-center">Total</th>
                                <th style="color: var(--text-secondary); font-weight: 700; padding: 1rem 0.75rem; font-size: 0.875rem; letter-spacing: 0.025em;" class="text-center">
                                    <span class="badge" style="background: rgba(242, 178, 102, 0.18); color: var(--warning-light); padding: 0.4rem 0.75rem; border: 1px solid rgba(242, 178, 102, 0.35); border-radius: 0.5rem; font-weight: 600; font-size: 0.75rem; line-height: 1.3; display: inline-block; box-shadow: none;">Benchmark<br/>Uncoded</span>
                                </th>
                                <th style="color: var(--text-secondary); font-weight: 700; padding: 1rem 0.75rem; font-size: 0.875rem; letter-spacing: 0.025em;" class="text-center">
                                    <span class="badge" style="background: rgba(241, 115, 115, 0.18); color: var(--danger-light); padding: 0.4rem 0.75rem; border: 1px solid rgba(241, 115, 115, 0.35); border-radius: 0.5rem; font-weight: 600; font-size: 0.75rem; line-height: 1.3; display: inline-block; box-shadow: none;">Model<br/>Uncoded</span>
                                </th>
                                <th style="color: var(--text-secondary); font-weight: 700; padding: 1rem 0.75rem; font-size: 0.875rem; letter-spacing: 0.025em;" class="text-center">
                                    <span class="badge" style="background: rgba(16, 185, 129, 0.18); color: var(--success-light); padding: 0.4rem 0.75rem; border: 1px solid rgba(16, 185, 129, 0.35); border-radius: 0.5rem; font-weight: 600; font-size: 0.75rem; line-height: 1.3; display: inline-block; box-shadow: none;">Both<br/>Uncoded</span>
                                </th>
                                <th style="color: var(--text-secondary); font-weight: 700; padding: 1rem 0.75rem; font-size: 0.875rem; letter-spacing: 0.025em; text-transform: uppercase;" class="text-center">Overlap %</th>
                                <th style="color: #475569; font-weight: 700; padding: 1rem 0.75rem; font-size: 0.875rem; letter-spacing: 0.025em; text-transform: uppercase;" class="text-center">Accuracy</th>
                            </tr>
                        </thead>
                        <tbody id="questionUncodedTableBody">
                            <!-- Table rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Download Section - Prominent -->
            <div class="section-group mb-5" id="downloadSection" style="display: none;">
                <div class="download-card">
                    <div class="row align-items-center g-4">
                        <div class="col-lg-8">
                            <div class="d-flex align-items-center mb-3">
                                <div class="download-icon-wrapper me-3">
                                    <i class="fas fa-file-csv fa-2x"></i>
                                </div>
                                <div>
                                    <h4 class="mb-1" style="color: var(--text-primary); font-weight: 600;">
                                        Download Complete Mismatch Report
                                    </h4>
                                    <p class="text-muted mb-0 small">
                                        <i class="fas fa-info-circle me-1"></i>Available immediately after evaluation
                                    </p>
                                </div>
                            </div>
                            <p class="mb-0" style="color: var(--text-secondary); line-height: 1.6;">
                                Export all mismatched responses as a CSV file with verbatim text, missed codes, extra codes, and detailed analysis for further review and improvement.
                            </p>
                        </div>
                        <div class="col-lg-4 text-lg-end">
                            <button class="btn btn-lg btn-success w-100 w-lg-auto" id="downloadCsvBtn" disabled>
                                <i class="fas fa-download me-2"></i>Download CSV
                            </button>
                            <div id="downloadStatus" class="mt-2 small text-muted" style="display: none;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Visualizations Section -->
            <div class="section-group mb-5">
                <h3 class="section-title mb-4">
                    <i class="fas fa-chart-area me-2" style="color: var(--primary-color);"></i>Visualizations
                </h3>
                <div class="row g-4">
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <div class="d-flex align-items-center justify-content-between mb-3">
                                <h4 class="mb-0">
                                    <i class="fas fa-chart-pie me-2"></i>Performance Overview
                                </h4>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="metricsChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <div class="d-flex align-items-center justify-content-between mb-3">
                                <h4 class="mb-0">
                                    <i class="fas fa-signal me-2"></i>Confusion Matrix
                                </h4>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="confusionChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Code Performance Analysis -->
            <div class="section-group mb-5">
                <h3 class="section-title mb-4">
                    <i class="fas fa-code me-2" style="color: var(--primary-color);"></i>Code Performance Analysis
                </h3>
                <div class="row g-4">
                    <div class="col-lg-6">
                        <div class="code-table">
                            <div class="d-flex align-items-center mb-3">
                                <i class="fas fa-arrow-up me-2" style="color: var(--success-light); font-size: 1.25rem;"></i>
                                <h4 class="mb-0">Top 10 Performing Codes</h4>
                            </div>
                            <div id="topCodes"></div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="code-table">
                            <div class="d-flex align-items-center mb-3">
                                <i class="fas fa-arrow-down me-2" style="color: #f87171; font-size: 1.25rem;"></i>
                                <h4 class="mb-0">Bottom 10 Performing Codes</h4>
                            </div>
                            <div id="bottomCodes"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mismatch Details Section -->
            <div class="section-group mb-5" id="mismatchSection" style="display: none;">
                <h3 class="section-title mb-3">
                    <i class="fas fa-exclamation-triangle me-2" style="color: var(--warning-color);"></i>Top Mismatches
                </h3>
                <div class="code-table mismatch-details" style="padding: 1.5rem;">
                    <div class="mb-3">
                        <h5 class="mb-1" id="mismatchTitle">Mismatched Responses</h5>
                        <small class="text-muted">
                            <span class="badge bg-danger me-1">❌ Missed</span> = Should have predicted | 
                            <span class="badge bg-warning text-dark me-1">⚠️ Extra</span> = Should NOT have predicted
                        </small>
                    </div>
                    <div id="worstMismatches" class="mismatch-list">                    </div>
                </div>
            </div>
        </div>
            </div>
            <!-- End Code Assignment Tab -->

            <!-- Hierarchy Evaluation Tab -->
            <div class="tab-pane fade" id="hierarchy" role="tabpanel">
                <div class="upload-section">
                    <h2 class="mb-4"><i class="fas fa-sitemap me-2"></i>Hierarchy Evaluation</h2>
                    
                    <div class="row g-4">
                        <!-- Benchmark Upload -->
                        <div class="col-md-6">
                            <h3 class="mb-3"><i class="fas fa-database me-2"></i>Benchmark XML</h3>
                            <div class="upload-area" id="benchmarkHierarchyUpload">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <h4>Drag & Drop Benchmark XML</h4>
                                <p class="text-muted">or click to browse</p>
                                <input type="file" id="benchmarkHierarchyInput" accept=".xml" style="display: none;">
                                <div id="benchmarkHierarchyInfo" class="mt-3" style="display: none;">
                                    <span class="badge bg-primary fs-6">
                                        <i class="fas fa-file-code me-2"></i><span id="benchmarkHierarchyFileName"></span>
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Model Upload -->
                        <div class="col-md-6">
                            <h3 class="mb-3"><i class="fas fa-robot me-2"></i>Model Output XML</h3>
                            <div class="upload-area" id="modelHierarchyUpload">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <h4>Drag & Drop Model XML</h4>
                                <p class="text-muted">or click to browse</p>
                                <input type="file" id="modelHierarchyInput" accept=".xml" style="display: none;">
                                <div id="modelHierarchyInfo" class="mt-3" style="display: none;">
                                    <span class="badge bg-success fs-6">
                                        <i class="fas fa-file-code me-2"></i><span id="modelHierarchyFileName"></span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Evaluate Button -->
                    <div class="text-center mt-4">
                        <button class="btn btn-evaluate text-white" id="evaluateHierarchyBtn" disabled>
                            <i class="fas fa-chart-line me-2"></i>Evaluate Hierarchy
                        </button>
                    </div>
                </div>

                <!-- Hierarchy Results Section -->
                <div class="results-section" id="hierarchyResultsSection" style="display: none;">
                    <div class="results-header mb-5">
                        <h2 class="mb-2"><i class="fas fa-sitemap me-2"></i>Hierarchy Evaluation Results</h2>
                    </div>

                    <!-- Comparison Metrics -->
                    <div class="section-group mb-5">
                        <h3 class="section-title mb-4">
                            <i class="fas fa-chart-bar me-2"></i>Comparison Metrics
                        </h3>
                        <div class="row g-4">
                            <div class="col-lg-3 col-md-6">
                                <div class="metric-card text-center">
                                    <div class="metric-icon-wrapper">
                                        <i class="fas fa-project-diagram fa-2x" style="color: var(--primary-light);"></i>
                                    </div>
                                    <div class="metric-label">Node Similarity</div>
                                    <div class="metric-value" id="nodeSimilarity">-</div>
                                    <small class="text-muted">Semantic alignment</small>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <div class="metric-card text-center">
                                    <div class="metric-icon-wrapper">
                                        <i class="fas fa-code-branch fa-2x" style="color: var(--success-light);"></i>
                                    </div>
                                    <div class="metric-label">Tree Edit Distance</div>
                                    <div class="metric-value" id="treeEditDistance">-</div>
                                    <small class="text-muted">Structural differences</small>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <div class="metric-card text-center">
                                    <div class="metric-icon-wrapper">
                                        <i class="fas fa-link fa-2x" style="color: var(--warning-light);"></i>
                                    </div>
                                    <div class="metric-label">Ancestor Agreement</div>
                                    <div class="metric-value" id="ancestorAgreement">-</div>
                                    <small class="text-muted">Relation preservation</small>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <div class="metric-card text-center">
                                    <div class="metric-icon-wrapper">
                                        <i class="fas fa-route fa-2x" style="color: var(--accent-purple-light);"></i>
                                    </div>
                                    <div class="metric-label">Path Jaccard</div>
                                    <div class="metric-value" id="pathJaccard">-</div>
                                    <small class="text-muted">Path overlap</small>
                                </div>
                            </div>
                        </div>
                        <div class="row g-4 mt-2">
                            <div class="col-lg-3 col-md-6">
                                <div class="metric-card text-center">
                                    <div class="metric-icon-wrapper">
                                        <i class="fas fa-sitemap fa-2x" style="color: var(--accent-indigo);"></i>
                                    </div>
                                    <div class="metric-label">Δ Coherence</div>
                                    <div class="metric-value" id="deltaCoherence">-</div>
                                    <small class="text-muted">Model - Benchmark</small>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <div class="metric-card text-center">
                                    <div class="metric-icon-wrapper">
                                        <i class="fas fa-layer-group fa-2x" style="color: var(--warning-light);"></i>
                                    </div>
                                    <div class="metric-label">Δ Overlap</div>
                                    <div class="metric-value" id="deltaOverlap">-</div>
                                    <small class="text-muted">Human - Model</small>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <div class="metric-card text-center">
                                    <div class="metric-icon-wrapper">
                                        <i class="fas fa-chart-area fa-2x" style="color: var(--success-light);"></i>
                                    </div>
                                    <div class="metric-label">Δ Granularity</div>
                                    <div class="metric-value" id="deltaGranularity">-</div>
                                    <small class="text-muted">Model - Benchmark</small>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <div class="metric-card text-center">
                                    <div class="metric-icon-wrapper">
                                        <i class="fas fa-link fa-2x" style="color: var(--primary-light);"></i>
                                    </div>
                                    <div class="metric-label">Δ Consistency</div>
                                    <div class="metric-value" id="deltaConsistency">-</div>
                                    <small class="text-muted">Model - Benchmark</small>
                                </div>
                            </div>
                        </div>
                        <div class="row g-4 mt-2">
                            <div class="col-lg-3 col-md-6">
                                <div class="metric-card metric-primary text-center">
                                    <div class="metric-icon-wrapper">
                                        <i class="fas fa-star fa-2x" style="color: var(--primary-light);"></i>
                                    </div>
                                    <div class="metric-label">HQI</div>
                                    <div class="metric-value" id="hqi">-</div>
                                    <small class="text-muted">Quality index</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Hierarchy Statistics -->
                    <div class="section-group mb-5">
                        <h3 class="section-title mb-4">
                            <i class="fas fa-info-circle me-2"></i>Hierarchy Statistics
                        </h3>
                        <div class="row g-4">
                            <div class="col-md-6">
                                <div class="chart-container">
                                    <h4 class="mb-3">Benchmark Hierarchy</h4>
                                    <div id="benchmarkStats"></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="chart-container">
                                    <h4 class="mb-3">Model Hierarchy</h4>
                                    <div id="modelStats"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Hierarchy Visualization -->
                    <div class="section-group mb-5">
                        <h3 class="section-title mb-4">
                            <i class="fas fa-sitemap me-2"></i>Hierarchy Visualization
                        </h3>
                        <div class="row g-4">
                            <div class="col-md-6">
                                <div class="chart-container">
                                    <h4 class="mb-3">Benchmark</h4>
                                    <div id="benchmarkTree" style="min-height: 400px; overflow: auto;"></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="chart-container">
                                    <h4 class="mb-3">Model</h4>
                                    <div id="modelTree" style="min-height: 400px; overflow: auto;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Hierarchy Tab -->
        </div>
        <!-- End Tab Content -->
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let selectedFile = null;
        let selectedBenchmark = null;
        let metricsChart = null;
        let confusionChart = null;

        // File Upload Handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');

        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                handleFileSelect();
            }
        });
        
        fileInput.addEventListener('change', handleFileSelect);

        function handleFileSelect() {
            if (fileInput.files.length > 0) {
                selectedFile = fileInput.files[0];
                fileName.textContent = selectedFile.name;
                fileInfo.style.display = 'block';
                checkReadyToEvaluate();
            }
        }

        // Benchmark Selection
        document.querySelectorAll('.benchmark-card').forEach(card => {
            card.addEventListener('click', function() {
                document.querySelectorAll('.benchmark-card').forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
                selectedBenchmark = this.dataset.benchmark;
                checkReadyToEvaluate();
            });
        });

        function checkReadyToEvaluate() {
            const btn = document.getElementById('evaluateBtn');
            btn.disabled = !(selectedFile && selectedBenchmark);
        }

        // Evaluate Button
        document.getElementById('evaluateBtn').addEventListener('click', async () => {
            if (!selectedFile || !selectedBenchmark) return;

            // Check file size (16MB limit for Render free tier)
            const maxSize = 16 * 1024 * 1024; // 16MB
            if (selectedFile.size > maxSize) {
                alert(`File too large! Maximum size is 16MB. Your file is ${(selectedFile.size / 1024 / 1024).toFixed(1)}MB.`);
                return;
            }

            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('benchmark', selectedBenchmark);

            document.getElementById('loadingOverlay').classList.add('active');

            // Add timeout controller (2 minutes for large files)
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 120000); // 120 seconds

            try {
                console.log('[DEBUG] Starting fetch request...');
                const response = await fetch('/api/evaluate', {
                    method: 'POST',
                    body: formData,
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                console.log('[DEBUG] Response received, status:', response.status);
                console.log('[DEBUG] Response headers:', Object.fromEntries(response.headers.entries()));
                
                // Check content size from header
                const contentSize = response.headers.get('X-Content-Size') || response.headers.get('Content-Length');
                if (contentSize) {
                    console.log('[DEBUG] Response size:', contentSize, 'bytes');
                }

                console.log('[DEBUG] Starting JSON parse...');
                let data;
                
                // Try to parse JSON response
                try {
                    const responseText = await response.text();
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    // If JSON parse fails, response might be HTML or plain text
                    if (!response.ok) {
                        showPageError(
                            `Server Error: ${response.status} ${response.statusText}`,
                            'The server returned an error. Please check your file and try again.',
                            'Verify your XML file matches the benchmark format and try again.'
                        );
                        return;
                    }
                    throw parseError;
                }
                
                console.log('[DEBUG] JSON parse complete');
                console.log('[DEBUG] Response keys:', Object.keys(data));
                console.log('[DEBUG] Response size:', JSON.stringify(data).length, 'bytes');

                if (!response.ok || data.error) {
                    // Display detailed error message on page
                    showPageError(
                        data.error || `Server Error: ${response.status} ${response.statusText}`,
                        data.message || 'An error occurred during evaluation.',
                        data.suggestion || 'Please check your file format and try again.'
                    );
                    return;
                }

                try {
                    displayResults(data);
                } catch (displayError) {
                    console.error('[ERROR] displayResults failed:', displayError);
                    showPageError(
                        'Display Error',
                        displayError.message,
                        'Check browser console for details. The data may be corrupted or incomplete.'
                    );
                    throw displayError; // Re-throw to trigger catch block
                }
            } catch (error) {
                clearTimeout(timeoutId);
                let errorTitle = 'Evaluation Failed';
                let errorMsg = '';
                let suggestion = '';
                
                if (error.name === 'AbortError') {
                    errorMsg = 'Request timeout! The evaluation took too long (>2 minutes).';
                    suggestion = 'Try with a smaller file or simpler benchmark.';
                } else if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
                    errorMsg = 'Network error! Unable to connect to the server.';
                    suggestion = 'Check if the server is running and try again.';
                } else {
                    errorMsg = error.message || 'An unexpected error occurred.';
                    suggestion = 'Please check your file format and try again.';
                }
                
                console.error('[ERROR] Evaluation error:', error);
                console.error('[ERROR] Error stack:', error.stack);
                
                showPageError(errorTitle, errorMsg, suggestion);
            } finally {
                // Always remove loading overlay, even on error
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) {
                    loadingOverlay.classList.remove('active');
                    console.log('[DEBUG] Loading overlay removed');
                }
            }
        });

        // Function to display errors on the page instead of alert dialogs
        function showPageError(title, message, suggestion = '') {
            const resultsSection = document.getElementById('resultsSection');
            
            // Build error HTML with better styling
            let errorHtml = `
                <div class="error-container" style="background: var(--card-bg); border: 2px solid var(--danger-color); border-radius: 0.75rem; padding: 2rem; margin-bottom: 2rem;">
                    <div class="d-flex align-items-start mb-3">
                        <div class="error-icon me-3" style="font-size: 2rem; color: var(--danger-color);">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div style="flex: 1;">
                            <h3 class="mb-2" style="color: var(--danger-color); font-weight: 600;">
                                ${title}
                            </h3>
                            <div class="error-message" style="color: var(--text-secondary); line-height: 1.6; margin-bottom: 1rem;">
                                ${message.includes('\n') ? `<pre style="white-space: pre-wrap; font-size: 0.9rem; background: rgba(248, 113, 113, 0.08); padding: 1rem; border-radius: 0.5rem; border-left: 3px solid var(--danger-color);">${message}</pre>` : message}
                            </div>
                            ${suggestion ? `
                                <div class="error-suggestion" style="background: rgba(251, 191, 36, 0.08); border-left: 3px solid var(--warning-light); padding: 1rem; border-radius: 0.25rem; margin-top: 1rem;">
                                    <strong style="color: var(--warning-light);"><i class="fas fa-lightbulb me-2"></i>Suggestion:</strong>
                                    <div style="color: var(--text-secondary); margin-top: 0.5rem;">${suggestion}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    <div class="text-end">
                        <button class="btn btn-primary" onclick="document.getElementById('resultsSection').style.display='none'; document.getElementById('resultsSection').innerHTML='';">
                            <i class="fas fa-times me-2"></i>Dismiss
                        </button>
                    </div>
                </div>
            `;
            
            resultsSection.innerHTML = errorHtml;
            resultsSection.style.display = 'block';
            resultsSection.classList.add('active');
            resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function displayResults(data) {
            console.log('[DEBUG] displayResults called with:', data);
            
            if (!data || !data.overall) {
                throw new Error('Invalid response data: missing overall metrics');
            }
            
            const results = data.overall;
            
            try {
                // Update main evaluation metrics (coded responses only)
                const codedOnly = results.coded_only || {};
                
                if (codedOnly.f1_micro !== undefined) updateMetric('f1Micro', codedOnly.f1_micro, 'f1MicroLabel');
                if (codedOnly.precision_micro !== undefined) updateMetric('precision', codedOnly.precision_micro);
                if (codedOnly.recall_micro !== undefined) updateMetric('recall', codedOnly.recall_micro);
                if (codedOnly.exact_match_ratio !== undefined) updateMetric('exactMatch', codedOnly.exact_match_ratio, null, true);
                if (codedOnly.jaccard_mean !== undefined) updateMetric('jaccard', codedOnly.jaccard_mean);
                if (codedOnly.n_responses !== undefined) {
                    document.getElementById('nCodedResponses').textContent = codedOnly.n_responses.toLocaleString();
                }
                
                // F1 Macro (using overall since it's per-code)
                if (results.f1_macro !== undefined) updateMetric('f1Macro', results.f1_macro);
                
                // Total responses for context
                if (results.n_responses !== undefined) {
                    const nResponsesEl = document.getElementById('nResponses');
                    if (nResponsesEl) {
                        nResponsesEl.textContent = results.n_responses.toLocaleString();
                    }
                }

                // Display new metrics
                if (results.f1_macro_weighted !== undefined) updateMetric('f1MacroWeighted', results.f1_macro_weighted);
                if (results.hamming_loss !== undefined) {
                    const hammingLossEl = document.getElementById('hammingLoss');
                    if (hammingLossEl) {
                        hammingLossEl.textContent = results.hamming_loss.toFixed(4);
                        hammingLossEl.style.color = results.hamming_loss < 0.1 ? 'var(--success-color)' : (results.hamming_loss < 0.3 ? 'var(--warning-color)' : 'var(--danger-color)');
                    }
                }

                // Display coded responses only metrics
                if (results.coded_only && results.coded_only.n_responses > 0) {
                    const codedSection = document.getElementById('codedOnlySection');
                    const coded = results.coded_only;
                    
                    if (codedSection) {
                        codedSection.style.display = 'block';
                        
                        if (coded.exact_match_ratio !== undefined) {
                            const exactMatchEl = document.getElementById('codedExactMatch');
                            if (exactMatchEl) {
                                exactMatchEl.textContent = (coded.exact_match_ratio * 100).toFixed(1) + '%';
                            }
                        }
                        
                        if (coded.n_responses !== undefined) {
                            const nResponsesEl = document.getElementById('codedNResponses');
                            if (nResponsesEl) {
                                nResponsesEl.textContent = `${coded.n_responses.toLocaleString()} coded responses`;
                            }
                        }
                        
                        if (coded.jaccard_mean !== undefined) updateMetric('codedJaccard', coded.jaccard_mean);
                        if (coded.f1_micro !== undefined) updateMetric('codedF1', coded.f1_micro);
                        if (coded.precision_micro !== undefined) updateMetric('codedPrecision', coded.precision_micro);
                    }
                } else {
                    const codedSection = document.getElementById('codedOnlySection');
                    if (codedSection) codedSection.style.display = 'none';
                }

                // Display uncoded classification performance (separate evaluation)
                const uncodedClfSection = document.getElementById('uncodedClassificationSection');
                if (results.uncoded_classification && results.uncoded_classification.total_cases > 0) {
                    const uncodedClf = results.uncoded_classification;
                    
                    if (uncodedClfSection) {
                        uncodedClfSection.style.display = 'block';
                        
                        // Overlap
                        if (uncodedClf.overlap_count !== undefined) {
                            document.getElementById('uncodedOverlapCount').textContent = uncodedClf.overlap_count.toLocaleString();
                        }
                        if (uncodedClf.overlap_percentage !== undefined) {
                            document.getElementById('uncodedOverlapPct').textContent = uncodedClf.overlap_percentage.toFixed(1) + '%';
                        }
                        
                        // Classification accuracy
                        if (uncodedClf.accuracy !== undefined) {
                            updateMetric('uncodedClassificationAccuracy', uncodedClf.accuracy);
                        }
                        
                        // Incorrectly coded (model coded when shouldn't)
                        if (uncodedClf.false_positives !== undefined) {
                            document.getElementById('incorrectlyCodedCount').textContent = uncodedClf.false_positives.toLocaleString();
                        }
                        
                        // Total benchmark uncoded
                        if (uncodedClf.total_cases !== undefined) {
                            document.getElementById('uncodedBenchmarkTotal').textContent = uncodedClf.total_cases.toLocaleString();
                        }
                        
                        // Show examples of incorrectly coded responses
                        if (uncodedClf.incorrectly_coded_responses && uncodedClf.incorrectly_coded_responses.length > 0) {
                            const examplesDiv = document.getElementById('incorrectlyCodedExamples');
                            const tableBody = document.getElementById('incorrectlyCodedTableBody');
                            
                            if (examplesDiv && tableBody) {
                                examplesDiv.style.display = 'block';
                                tableBody.innerHTML = '';
                                
                                uncodedClf.incorrectly_coded_responses.slice(0, 10).forEach(item => {
                                    const row = document.createElement('tr');
                                    row.innerHTML = `
                                        <td>${item.respondent_id}</td>
                                        <td>${item.question_id}</td>
                                        <td><span class="badge bg-warning text-dark">${item.assigned_codes.join(', ')}</span></td>
                                        <td class="text-center">${item.assigned_code_count}</td>
                                    `;
                                    tableBody.appendChild(row);
                                });
                                
                                if (uncodedClf.incorrectly_coded_responses.length > 10) {
                                    const row = document.createElement('tr');
                                    row.innerHTML = `
                                        <td colspan="4" class="text-center text-muted">
                                            ... and ${uncodedClf.incorrectly_coded_responses.length - 10} more (see CSV for full list)
                                        </td>
                                    `;
                                    tableBody.appendChild(row);
                                }
                            }
                        }
                    }
                } else if (uncodedClfSection) {
                    uncodedClfSection.style.display = 'none';
                }

                // Display question-level uncoded breakdown
                if (results.question_uncoded_breakdown && results.question_uncoded_breakdown.length > 0) {
                    // Filter to only show questions with uncoded responses
                    const questionsWithUncoded = results.question_uncoded_breakdown.filter(q => 
                        q.benchmark_uncoded > 0 || q.model_uncoded > 0 || q.both_uncoded > 0
                    );
                    
                    const questionSection = document.getElementById('questionUncodedSection');
                    const tableBody = document.getElementById('questionUncodedTableBody');
                    
                    if (questionSection && tableBody) {
                        if (questionsWithUncoded.length > 0) {
                            // Show section if there are questions with uncoded responses
                            questionSection.style.display = 'block';
                            tableBody.innerHTML = '';
                            const noUncodedMsg = document.getElementById('noUncodedMessage');
                            if (noUncodedMsg) noUncodedMsg.style.display = 'none';
                            
                            questionsWithUncoded.forEach((q, idx) => {
                                const row = document.createElement('tr');
                                row.style.borderBottom = '1px solid var(--card-border)';
                                
                                // Highlight rows with high overlap
                                const overlapPct = q.overlap_percentage || 0;
                                if (overlapPct >= 80 && q.both_uncoded > 0) {
                                    row.style.background = 'rgba(16, 185, 129, 0.04)';
                                } else if (overlapPct < 50 && (q.benchmark_uncoded > 0 || q.model_uncoded > 0)) {
                                    row.style.background = 'rgba(248, 113, 113, 0.04)';
                                }
                                
                                // Calculate accuracy color - only if there are benchmark uncoded to calculate from
                                const accuracyColor = q.benchmark_uncoded > 0 ? 
                                    (q.classification_accuracy >= 0.8 ? 'var(--success-color)' : 
                                     (q.classification_accuracy >= 0.5 ? 'var(--warning-color)' : 'var(--danger-color)')) : 
                                    'var(--text-secondary)';
                                
                                const accuracyDisplay = q.benchmark_uncoded > 0 ? 
                                    `${(q.classification_accuracy * 100).toFixed(1)}%` : 
                                    'N/A';
                                
                                row.innerHTML = `
                                    <td style="font-weight: 500; color: var(--text-primary);">
                                        <strong>${q.question_id}</strong>
                                    </td>
                                    <td class="text-center" style="color: var(--text-secondary);">
                                        ${q.total_responses}
                                    </td>
                                    <td class="text-center">
                                        <span class="badge" style="background: rgba(242, 178, 102, 0.18); color: var(--warning-light); padding: 0.35rem 0.65rem; border: 1px solid rgba(242, 178, 102, 0.35); border-radius: 0.375rem; font-weight: 500;">
                                            ${q.benchmark_uncoded}
                                            <small>(${q.benchmark_uncoded_percentage.toFixed(1)}%)</small>
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge" style="background: rgba(241, 115, 115, 0.18); color: var(--danger-light); padding: 0.35rem 0.65rem; border: 1px solid rgba(241, 115, 115, 0.35); border-radius: 0.375rem; font-weight: 500;">
                                            ${q.model_uncoded}
                                            <small>(${q.model_uncoded_percentage.toFixed(1)}%)</small>
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge" style="background: rgba(16, 185, 129, 0.18); color: var(--success-light); padding: 0.35rem 0.65rem; border: 1px solid rgba(16, 185, 129, 0.35); border-radius: 0.375rem; font-weight: 500;">
                                            ${q.both_uncoded}
                                        </span>
                                    </td>
                                <td class="text-center" style="font-weight: 600; color: ${overlapPct >= 80 ? 'var(--success-light)' : (overlapPct < 50 && overlapPct > 0 ? 'var(--danger-light)' : 'var(--warning-light)')};">
                                    ${overlapPct.toFixed(1)}%
                                </td>
                                `;
                                
                                tableBody.appendChild(row);
                            });
                        } else {
                            // No uncoded responses found - show message and hide table
                            questionSection.style.display = 'block';
                            tableBody.innerHTML = '';
                            const noUncodedMsg = document.getElementById('noUncodedMessage');
                            if (noUncodedMsg) noUncodedMsg.style.display = 'block';
                        }
                    }
                } else {
                    const questionSection = document.getElementById('questionUncodedSection');
                    const noUncodedMsg = document.getElementById('noUncodedMessage');
                    if (questionSection) {
                        questionSection.style.display = 'none';
                    }
                    if (noUncodedMsg) {
                        noUncodedMsg.style.display = 'none';
                    }
                }

                // Display top/bottom codes
                if (data.top_codes && Array.isArray(data.top_codes)) {
                    displayCodeList('topCodes', data.top_codes);
                }
                if (data.bottom_codes && Array.isArray(data.bottom_codes)) {
                    displayCodeList('bottomCodes', data.bottom_codes);
                }

                // Show download section when results are available
                document.getElementById('downloadSection').style.display = 'block';
                
                // Get download button and enable/disable based on mismatches
                const downloadBtn = document.getElementById('downloadCsvBtn');
                if (!downloadBtn) {
                    console.error('[ERROR] Download button not found!');
                } else {
                    // Check multiple possible locations for mismatch data
                    const mismatchCount = data.mismatch_count || 
                                         (data.overall && data.overall.n_mismatches) || 
                                         0;
                    const hasMismatches = data.has_mismatches === true || 
                                         mismatchCount > 0 ||
                                         (data.overall && data.overall.n_mismatches > 0);
                    
                    console.log('[DEBUG] Download button state check:', {
                        has_mismatches: data.has_mismatches,
                        mismatch_count: data.mismatch_count,
                        n_mismatches: data.overall?.n_mismatches,
                        calculatedMismatchCount: mismatchCount,
                        calculatedHasMismatches: hasMismatches,
                        fullData: data
                    });
                    
                    if (hasMismatches && mismatchCount > 0) {
                        document.getElementById('mismatchSection').style.display = 'block';
                        document.getElementById('mismatchTitle').textContent = `Found ${mismatchCount} Mismatched Responses`;
                        document.getElementById('worstMismatches').innerHTML = `
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>${mismatchCount}</strong> mismatched responses found.
                                Click the button above to download the complete mismatch report with verbatim text and code details.
                            </div>
                        `;
                        // Enable download button
                        downloadBtn.removeAttribute('disabled');
                        downloadBtn.disabled = false;
                        downloadBtn.style.opacity = '1';
                        downloadBtn.style.cursor = 'pointer';
                        downloadBtn.classList.remove('disabled');
                        console.log('[DEBUG] ✅ Download button ENABLED - mismatches found:', mismatchCount);
                    } else {
                        document.getElementById('mismatchSection').style.display = 'none';
                        // Disable download button if no mismatches
                        downloadBtn.setAttribute('disabled', 'disabled');
                        downloadBtn.disabled = true;
                        downloadBtn.style.opacity = '0.5';
                        downloadBtn.style.cursor = 'not-allowed';
                        downloadBtn.classList.add('disabled');
                        console.log('[DEBUG] ❌ Download button DISABLED - no mismatches found. Count:', mismatchCount);
                    }
                }

                // Create charts (wrap in try-catch in case Chart.js fails)
                try {
                    createMetricsChart(results);
                } catch (chartError) {
                    console.error('[ERROR] Metrics chart creation failed:', chartError);
                }
                
                try {
                    createConfusionChart(results);
                } catch (chartError) {
                    console.error('[ERROR] Confusion chart creation failed:', chartError);
                }

                // Show results section
                const resultsSection = document.getElementById('resultsSection');
                resultsSection.style.display = 'block';
                resultsSection.classList.add('active');
                resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                console.log('[DEBUG] displayResults completed successfully');
            } catch (error) {
                console.error('[ERROR] Error in displayResults:', error);
                throw error;
            }
        }

        function updateMetric(elementId, value, labelId = null, isPercentage = false) {
            const element = document.getElementById(elementId);
            const displayValue = isPercentage ? (value * 100).toFixed(1) + '%' : value.toFixed(3);
            element.textContent = displayValue;

            // Color coding
            element.className = 'metric-value ';
            if (value >= 0.75) element.classList.add('metric-excellent');
            else if (value >= 0.60) element.classList.add('metric-good');
            else if (value >= 0.40) element.classList.add('metric-fair');
            else element.classList.add('metric-poor');

            if (labelId) {
                const label = document.getElementById(labelId);
                if (value >= 0.75) label.textContent = 'Excellent';
                else if (value >= 0.60) label.textContent = 'Good';
                else if (value >= 0.40) label.textContent = 'Fair';
                else label.textContent = 'Needs Improvement';
            }
        }

        function displayDeltaMetric(elementId, delta) {
            const element = document.getElementById(elementId);
            const displayValue = delta >= 0 ? `+${delta.toFixed(3)}` : delta.toFixed(3);
            element.textContent = displayValue;
            
            // Color coding for delta metrics
            element.className = 'metric-value ';
            // For delta metrics, positive is often good (except overlap)
            if (elementId === 'deltaOverlap') {
                // For overlap, lower is better (human - model), so negative delta is good
                if (delta <= -0.05) element.classList.add('metric-excellent');
                else if (delta <= 0) element.classList.add('metric-good');
                else if (delta <= 0.1) element.classList.add('metric-fair');
                else element.classList.add('metric-poor');
            } else {
                // For other deltas, positive is often good
                if (delta >= 0.1) element.classList.add('metric-excellent');
                else if (delta >= 0) element.classList.add('metric-good');
                else if (delta >= -0.1) element.classList.add('metric-fair');
                else element.classList.add('metric-poor');
            }
        }

        function displayCodeList(containerId, codes) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            codes.forEach((code, idx) => {
                const codeDiv = document.createElement('div');
                codeDiv.className = 'border-bottom pb-2 mb-2';
                codeDiv.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <small class="badge badge-depth-${code.depth} me-2">L${code.depth}</small>
                            <small class="text-muted">[${code.code}]</small>
                            <div class="mt-1"><strong>${code.description}</strong></div>
                        </div>
                        <div class="text-end">
                            <div class="badge ${code.f1 >= 0.7 ? 'bg-success' : code.f1 >= 0.5 ? 'bg-warning' : 'bg-danger'}">
                                F1: ${code.f1.toFixed(3)}
                            </div>
                            <div class="small text-muted mt-1">n=${code.support}</div>
                        </div>
                    </div>
                `;
                container.appendChild(codeDiv);
            });
        }

        function displayMismatches(mismatches, totalMismatches) {
            const container = document.getElementById('worstMismatches');
            const title = document.getElementById('mismatchTitle');
            container.innerHTML = '';
            title.textContent = `Top ${mismatches.length} Worst Mismatches (${totalMismatches} total)`;

            mismatches.forEach((mismatch, idx) => {
                const mismatchDiv = document.createElement('div');
                mismatchDiv.className = 'border-bottom pb-2 mb-3';
                
                // Compact header
                let html = `
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <div>
                            <span class="badge bg-secondary me-2">#${idx + 1}</span>
                            <small class="text-muted">R: ${mismatch.respondent_id} | Q: ${mismatch.question_id}</small>
                        </div>
                        <div>
                            <span class="badge bg-danger me-2">${mismatch.error_count} errors</span>
                            <small class="text-muted">J: ${mismatch.jaccard.toFixed(2)}</small>
                        </div>
                    </div>
                `;

                // Compact missed codes row - show code key and description
                if (mismatch.missed_codes && mismatch.missed_codes.length > 0) {
                    const missedItems = mismatch.missed_codes.map((code, i) => {
                        const desc = mismatch.missed_descriptions && mismatch.missed_descriptions[i] ? mismatch.missed_descriptions[i] : 'Unknown';
                        return `<span class="badge bg-danger me-2 mb-1"><strong>${code}</strong>: ${desc}</span>`;
                    }).join('');
                    html += `
                        <div class="mb-2">
                            <strong class="text-danger small me-2">❌ Missed:</strong>
                            <div class="d-flex flex-wrap gap-1 mt-1">
                                ${missedItems}
                            </div>
                        </div>
                    `;
                }

                // Compact extra codes row - show code key and description
                if (mismatch.extra_codes && mismatch.extra_codes.length > 0) {
                    const extraItems = mismatch.extra_codes.map((code, i) => {
                        const desc = mismatch.extra_descriptions && mismatch.extra_descriptions[i] ? mismatch.extra_descriptions[i] : 'Unknown';
                        return `<span class="badge bg-warning text-dark me-2 mb-1"><strong>${code}</strong>: ${desc}</span>`;
                    }).join('');
                    html += `
                        <div class="mb-2">
                            <strong class="text-warning small me-2">⚠️ Extra:</strong>
                            <div class="d-flex flex-wrap gap-1 mt-1">
                                ${extraItems}
                            </div>
                        </div>
                    `;
                }

                mismatchDiv.innerHTML = html;
                container.appendChild(mismatchDiv);
            });
        }

        // CSV Download Handler
        document.getElementById('downloadCsvBtn').addEventListener('click', async () => {
            const btn = document.getElementById('downloadCsvBtn');
            const statusDiv = document.getElementById('downloadStatus');
            const originalText = btn.innerHTML;
            
            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating CSV...';
                if (statusDiv) {
                    statusDiv.style.display = 'block';
                    statusDiv.innerHTML = '<i class="fas fa-clock me-1"></i>Generating CSV file...';
                    statusDiv.style.color = 'var(--text-secondary)';
                }
                
                console.log('[CSV] Starting download...');
                const response = await fetch('/api/download-mismatches');
                
                console.log('[CSV] Response status:', response.status);
                
                if (!response.ok) {
                    // Try to get detailed error message
                    let errorMsg = 'Download failed';
                    let suggestion = '';
                    try {
                        const data = await response.json();
                        errorMsg = data.error || errorMsg;
                        if (data.message) {
                            errorMsg += '\n\n' + data.message;
                        }
                        if (data.suggestion) {
                            suggestion = data.suggestion;
                        }
                    } catch (e) {
                        errorMsg = `Server error: ${response.status} ${response.statusText}`;
                    }
                    
                    // Show detailed error on page
                    showPageError(
                        'Download Error',
                        errorMsg,
                        suggestion || 'Please try again or check the browser console for details.'
                    );
                    console.error('[CSV] Download error details:', { errorMsg, suggestion });
                    return;
                }
                
                // Get filename from Content-Disposition header or use default
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'mismatches.csv';
                if (contentDisposition) {
                    const matches = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/.exec(contentDisposition);
                    if (matches && matches[1]) {
                        filename = matches[1].replace(/['"]/g, '');
                    }
                }
                
                console.log('[CSV] Downloading file:', filename);
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                console.log('[CSV] Download complete');
                if (statusDiv) {
                    statusDiv.innerHTML = '<i class="fas fa-check-circle me-1" style="color: var(--success-color);"></i>Download complete!';
                    statusDiv.style.color = 'var(--success-color)';
                    setTimeout(() => {
                        statusDiv.style.display = 'none';
                    }, 3000);
                }
                } catch (error) {
                    console.error('[CSV] Download error:', error);
                    if (statusDiv) {
                        statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-1" style="color: var(--danger-color);"></i>Download failed';
                        statusDiv.style.color = 'var(--danger-color)';
                    }
                    showPageError(
                        'Download Failed',
                        error.message || 'An unexpected error occurred during download.',
                        'Please try again or check the browser console for details.'
                    );
                } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });

        function createMetricsChart(results) {
            const ctx = document.getElementById('metricsChart');
            
            if (metricsChart) metricsChart.destroy();

            metricsChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['F1 (Micro)', 'F1 (Macro)', 'Precision', 'Recall', 'Jaccard', 'Exact Match'],
                    datasets: [{
                        label: 'Model Performance',
                        data: [
                            results.f1_micro,
                            results.f1_macro,
                            results.precision_micro,
                            results.recall_micro,
                            results.jaccard_mean,
                            results.exact_match_ratio
                        ],
                        fill: true,
                        backgroundColor: 'rgba(59, 130, 246, 0.15)',
                        borderColor: 'rgb(59, 130, 246)',
                        pointBackgroundColor: 'rgb(59, 130, 246)',
                        pointBorderColor: 'rgba(26, 31, 53, 1)',
                        pointHoverBackgroundColor: 'rgb(96, 165, 250)',
                        pointHoverBorderColor: 'rgb(59, 130, 246)',
                        borderWidth: 2
                    }]
                },
                options: {
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 1,
                            ticks: {
                                stepSize: 0.2,
                                color: '#9ca3af',
                                backdropColor: 'transparent'
                            },
                            grid: {
                                color: 'rgba(42, 49, 72, 0.5)'
                            },
                            angleLines: {
                                color: 'rgba(42, 49, 72, 0.5)'
                            },
                            pointLabels: {
                                color: '#e5e7eb',
                                font: {
                                    size: 11
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function createConfusionChart(results) {
            const ctx = document.getElementById('confusionChart');
            
            if (confusionChart) confusionChart.destroy();

            confusionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['True Positives', 'False Positives', 'False Negatives'],
                    datasets: [{
                        label: 'Count',
                        data: [results.total_tp, results.total_fp, results.total_fn],
                        backgroundColor: [
                            'rgba(34, 197, 94, 0.5)',
                            'rgba(239, 68, 68, 0.5)',
                            'rgba(245, 158, 11, 0.5)'
                        ],
                        borderColor: [
                            'rgb(34, 197, 94)',
                            'rgb(239, 68, 68)',
                            'rgb(245, 158, 11)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#9ca3af'
                            },
                            grid: {
                                color: 'rgba(42, 49, 72, 0.5)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#e5e7eb'
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // ===== Hierarchy Evaluation Tab =====
        let benchmarkHierarchyFile = null;
        let modelHierarchyFile = null;

        // Benchmark hierarchy upload
        const benchmarkHierarchyUpload = document.getElementById('benchmarkHierarchyUpload');
        const benchmarkHierarchyInput = document.getElementById('benchmarkHierarchyInput');
        const benchmarkHierarchyInfo = document.getElementById('benchmarkHierarchyInfo');
        const benchmarkHierarchyFileName = document.getElementById('benchmarkHierarchyFileName');

        benchmarkHierarchyUpload.addEventListener('click', () => benchmarkHierarchyInput.click());
        benchmarkHierarchyInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                benchmarkHierarchyFile = e.target.files[0];
                benchmarkHierarchyFileName.textContent = benchmarkHierarchyFile.name;
                benchmarkHierarchyInfo.style.display = 'block';
                checkHierarchyReady();
            }
        });

        // Model hierarchy upload
        const modelHierarchyUpload = document.getElementById('modelHierarchyUpload');
        const modelHierarchyInput = document.getElementById('modelHierarchyInput');
        const modelHierarchyInfo = document.getElementById('modelHierarchyInfo');
        const modelHierarchyFileName = document.getElementById('modelHierarchyFileName');

        modelHierarchyUpload.addEventListener('click', () => modelHierarchyInput.click());
        modelHierarchyInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                modelHierarchyFile = e.target.files[0];
                modelHierarchyFileName.textContent = modelHierarchyFile.name;
                modelHierarchyInfo.style.display = 'block';
                checkHierarchyReady();
            }
        });

        function checkHierarchyReady() {
            const btn = document.getElementById('evaluateHierarchyBtn');
            btn.disabled = !(benchmarkHierarchyFile && modelHierarchyFile);
        }

        // Evaluate hierarchy
        document.getElementById('evaluateHierarchyBtn').addEventListener('click', async () => {
            if (!benchmarkHierarchyFile || !modelHierarchyFile) return;

            const formData = new FormData();
            formData.append('benchmark_file', benchmarkHierarchyFile);
            formData.append('model_file', modelHierarchyFile);

            document.getElementById('loadingOverlay').classList.add('active');

            try {
                const response = await fetch('/api/evaluate-hierarchy', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok || data.error) {
                    showPageError(
                        data.error || 'Hierarchy Evaluation Failed',
                        data.message || 'An error occurred during hierarchy evaluation.',
                        data.suggestion || 'Please check your files and try again.'
                    );
                    return;
                }

                displayHierarchyResults(data);
            } catch (error) {
                showPageError(
                    'Hierarchy Evaluation Failed',
                    error.message || 'An unexpected error occurred.',
                    'Please check your files and try again.'
                );
            } finally {
                document.getElementById('loadingOverlay').classList.remove('active');
            }
        });

        function displayHierarchyResults(data) {
            // Display comparison metrics
            if (data.comparison) {
                updateMetric('nodeSimilarity', data.comparison.node_similarity);
                document.getElementById('treeEditDistance').textContent = data.comparison.tree_edit_distance;
                updateMetric('ancestorAgreement', data.comparison.ancestor_descendant_agreement);
                if (data.comparison.path_based_jaccard !== undefined) {
                    updateMetric('pathJaccard', data.comparison.path_based_jaccard);
                }
                
                // Delta metrics (lines 49-52)
                if (data.comparison.delta_coherence !== undefined && data.comparison.delta_coherence !== null) {
                    displayDeltaMetric('deltaCoherence', data.comparison.delta_coherence);
                } else {
                    document.getElementById('deltaCoherence').textContent = 'N/A';
                }
                
                if (data.comparison.delta_overlap !== undefined && data.comparison.delta_overlap !== null) {
                    displayDeltaMetric('deltaOverlap', data.comparison.delta_overlap);
                } else {
                    document.getElementById('deltaOverlap').textContent = 'N/A';
                }
                
                if (data.comparison.delta_granularity !== undefined && data.comparison.delta_granularity !== null) {
                    displayDeltaMetric('deltaGranularity', data.comparison.delta_granularity);
                } else {
                    document.getElementById('deltaGranularity').textContent = 'N/A';
                }
                
                if (data.comparison.delta_consistency !== undefined && data.comparison.delta_consistency !== null) {
                    displayDeltaMetric('deltaConsistency', data.comparison.delta_consistency);
                } else {
                    document.getElementById('deltaConsistency').textContent = 'N/A';
                }
                
                updateMetric('hqi', data.comparison.hqi);
            }

            // Display statistics
            if (data.benchmark && data.benchmark.stats) {
                displayStats('benchmarkStats', data.benchmark.stats);
            }
            if (data.model && data.model.stats) {
                displayStats('modelStats', data.model.stats);
            }

            // Display trees
            if (data.benchmark && data.benchmark.tree) {
                displayTree('benchmarkTree', data.benchmark.tree);
            }
            if (data.model && data.model.tree) {
                displayTree('modelTree', data.model.tree);
            }

            // Show results section
            const resultsSection = document.getElementById('hierarchyResultsSection');
            resultsSection.style.display = 'block';
            resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function displayStats(containerId, stats) {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="mb-2"><strong>Total Nodes:</strong> ${stats.total_nodes || 0}</div>
                <div class="mb-2"><strong>Leaf Nodes:</strong> ${stats.leaf_nodes || 0}</div>
                <div class="mb-2"><strong>Max Depth:</strong> ${stats.max_depth || 0}</div>
                <div class="mb-2"><strong>Net Nodes:</strong> ${stats.net_nodes || 0}</div>
                <div class="mb-2"><strong>Code Nodes:</strong> ${stats.code_nodes || 0}</div>
                <div class="mb-2"><strong>Avg Branching:</strong> ${stats.avg_branching_factor || 0}</div>
                <div class="mb-2"><strong>Depth Variance:</strong> ${stats.depth_variance || 0}</div>
                ${stats.coherence !== undefined ? `
                    <div class="mt-3 pt-3 border-top" style="border-color: var(--card-border);">
                        <div class="mb-2"><strong>Coherence:</strong> <span class="${stats.coherence >= 0.75 ? 'text-success' : stats.coherence >= 0.5 ? 'text-warning' : 'text-danger'}">${stats.coherence.toFixed(3)}</span></div>
                        ${stats.overlap !== undefined ? `<div class="mb-2"><strong>Overlap:</strong> <span class="${stats.overlap <= 0.10 ? 'text-success' : stats.overlap <= 0.3 ? 'text-warning' : 'text-danger'}">${stats.overlap.toFixed(3)}</span></div>` : ''}
                        ${stats.consistency !== undefined ? `<div class="mb-2"><strong>Consistency:</strong> <span class="${stats.consistency >= 0.15 && stats.consistency <= 0.35 ? 'text-success' : 'text-warning'}">${stats.consistency.toFixed(3)}</span></div>` : ''}
                        ${stats.granularity ? `
                            <div class="mb-2"><strong>Granularity:</strong>
                                ${Object.entries(stats.granularity).map(([level, val]) => 
                                    `<span class="badge badge-depth-${level} me-1">L${level}: ${val.toFixed(2)}</span>`
                                ).join('')}
                            </div>
                        ` : ''}
                    </div>
                ` : ''}
                ${stats.depth_distribution ? `
                    <div class="mt-3">
                        <strong>Depth Distribution:</strong>
                        <div class="mt-2">
                            ${Object.entries(stats.depth_distribution).map(([depth, count]) => 
                                `<span class="badge badge-depth-${depth} me-2">Depth ${depth}: ${count}</span>`
                            ).join('')}
                        </div>
                    </div>
                ` : ''}
            `;
        }

        function displayTree(containerId, tree) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            function renderNode(node, level = 0) {
                const indent = level * 20;
                const isNet = node.is_net || false;
                const nodeClass = isNet ? 'text-primary' : 'text-secondary';
                const icon = isNet ? 'fa-folder' : 'fa-file';
                
                const nodeDiv = document.createElement('div');
                nodeDiv.className = 'mb-2';
                nodeDiv.style.paddingLeft = `${indent}px`;
                nodeDiv.innerHTML = `
                    <div class="d-flex align-items-center ${nodeClass}">
                        <i class="fas ${icon} me-2"></i>
                        <span class="badge badge-depth-${node.depth} me-2">L${node.depth}</span>
                        <strong>${node.key}</strong>
                        <span class="ms-2 text-muted">${node.description || ''}</span>
                    </div>
                `;
                container.appendChild(nodeDiv);
                
                if (node.children && node.children.length > 0) {
                    node.children.forEach(child => renderNode(child, level + 1));
                }
            }
            
            renderNode(tree);
        }

        // Tab switching styling
        document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
            tab.addEventListener('shown.bs.tab', function (e) {
                // Update active tab styling
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.style.color = 'var(--text-secondary)';
                    link.style.borderBottom = 'none';
                });
                e.target.style.color = 'var(--text-primary)';
                e.target.style.borderBottom = '2px solid var(--primary-color)';
            });
        });
        
        // Set initial active tab styling
        document.querySelector('.nav-link.active').style.color = 'var(--text-primary)';
        document.querySelector('.nav-link.active').style.borderBottom = '2px solid var(--primary-color)';
    </script>
</body>
</html>

