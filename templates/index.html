<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Coder Evaluation</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            /* Primary Colors - Elegant Blues */
            --primary-color: #4f8df5;
            --primary-light: #7ba6f8;
            --primary-dark: #3a6fd8;
            
            /* Success - Soft Emerald */
            --success-color: #10b981;
            --success-light: #34d399;
            --success-dark: #059669;
            
            /* Warning - Softer Amber */
            --warning-color: #f2b266; /* softened */
            --warning-light: #f6cf8f;
            --warning-dark: #d7923e;
            
            /* Danger - Muted Coral */
            --danger-color: #f17373; /* softened */
            --danger-light: #f6a2a2;
            --danger-dark: #e44747;
            
            /* Accent - Elegant Purple */
            --accent-purple: #8b5cf6;
            --accent-purple-light: #a78bfa;
            --accent-indigo: #6366f1;
            
            /* Background - Deep Navy */
            --dark-bg: #0f172a;
            --card-bg: #1e293b;
            --card-border: #334155;
            --surface-bg: #172033;
            
            /* Text - Soft Grays */
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            
            /* Accent Blue */
            --accent-blue: #60a5fa;
            --accent-blue-light: #93c5fd;
        }
        
        body {
            background: var(--dark-bg);
            min-height: 100vh;
            font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            color: var(--text-primary);
        }

        /* Dark grid table styling for better contrast */
        .table-dark-grid thead th {
            background: var(--surface-bg) !important;
            color: var(--text-primary) !important;
            border-bottom: 1px solid var(--card-border) !important;
        }
        .table-dark-grid tbody td {
            background: var(--card-bg) !important;
            color: var(--text-primary) !important;
            border-top: 1px solid var(--surface-bg) !important;
        }
        .table-dark-grid tbody tr:hover td {
            background: rgba(255, 255, 255, 0.02) !important;
        }
        
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        @media (max-width: 768px) {
            .main-container {
                padding: 1rem;
            }
            
            .results-header h2 {
                font-size: 1.5rem;
            }
            
            .section-title {
                font-size: 1.125rem;
            }
            
            .metric-value {
                font-size: 2rem;
            }
            
            .metric-icon-wrapper {
                width: 48px;
                height: 48px;
            }
            
            .metric-icon-wrapper i {
                font-size: 1.5rem !important;
            }
            
            .download-card {
                padding: 1.5rem;
            }
            
            .chart-wrapper {
                height: 250px;
            }
        }
        
        .header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem 0;
            border-bottom: 1px solid var(--card-border);
            animation: fadeInDown 0.6s;
        }
        
        .header h1 {
            font-size: 2.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            letter-spacing: -0.025em;
        }
        
        .header p {
            font-size: 1rem;
            color: var(--text-secondary);
            font-weight: 400;
        }
        
        .upload-section {
            background: var(--card-bg);
            border-radius: 0.75rem;
            padding: 2.5rem;
            border: 1px solid var(--card-border);
            margin-bottom: 2rem;
            animation: fadeInUp 0.6s;
        }
        
        .upload-section h2, .upload-section h3 {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1.125rem;
            letter-spacing: -0.025em;
        }
        
        .upload-area {
            border: 2px dashed var(--card-border);
            border-radius: 0.75rem;
            padding: 3rem;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            background: var(--surface-bg);
        }
        
        .upload-area:hover, .upload-area.dragover {
            border-color: var(--primary-color);
            background: rgba(59, 130, 246, 0.05);
            transform: translateY(-2px);
        }
        
        .upload-area i {
            font-size: 3rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }
        
        .upload-area h4 {
            color: var(--text-primary);
            font-weight: 500;
        }
        
        .upload-area p {
            color: var(--text-muted);
        }
        
        .benchmark-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        
        .benchmark-card {
            background: var(--surface-bg);
            border: 1px solid var(--card-border);
            border-radius: 0.5rem;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .benchmark-card h5 {
            color: var(--text-primary);
            font-weight: 500;
        }
        
        .benchmark-card p {
            color: var(--text-muted);
        }
        
        .benchmark-card:hover {
            transform: translateY(-2px);
            border-color: var(--primary-color);
            background: rgba(59, 130, 246, 0.05);
        }
        
        .benchmark-card.selected {
            border-color: var(--primary-color);
            background: rgba(59, 130, 246, 0.1);
            box-shadow: 0 0 0 1px var(--primary-color);
        }
        
        .btn-evaluate {
            background: var(--primary-color);
            border: none;
            padding: 0.875rem 2.5rem;
            font-size: 0.95rem;
            font-weight: 500;
            border-radius: 0.5rem;
            transition: all 0.2s;
            letter-spacing: 0.025em;
        }
        
        .btn-evaluate:hover:not(:disabled) {
            background: #2563eb;
            transform: translateY(-1px);
        }
        
        .btn-evaluate:disabled {
            background: var(--card-border);
            color: var(--text-muted);
            cursor: not-allowed;
        }
        
        .results-section {
            display: none;
            animation: fadeInUp 0.6s;
        }
        
        .results-section h2 {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1.25rem;
            letter-spacing: -0.025em;
        }
        
        /* Results Section */
        .results-section {
            display: none;
        }
        
        .results-section.active {
            display: block;
            animation: fadeInUp 0.6s;
        }
        
        .results-header {
            padding-bottom: 1.5rem;
            border-bottom: 2px solid var(--card-border);
        }
        
        .results-header h2 {
            font-size: 2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        
        /* Section Groups */
        .section-group {
            margin-bottom: 3rem;
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--primary-color);
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
        }
        
        .section-title i {
            margin-right: 0.75rem;
            color: var(--primary-color);
        }
        
        /* Metric Cards */
        .metric-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 0.75rem;
            padding: 1.75rem 1.5rem;
            transition: all 0.3s ease;
            min-height: 200px;
            height: 100%;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--success-color));
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-4px);
            border-color: var(--primary-color);
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.15);
        }
        
        .metric-card:hover::before {
            opacity: 1;
        }
        
        .metric-card.metric-primary {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(34, 197, 94, 0.05) 100%);
            border: 1.5px solid var(--card-border);
        }
        
        .metric-card.metric-primary:hover {
            border-color: var(--primary-color);
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.12) 0%, rgba(34, 197, 94, 0.08) 100%);
        }
        
        .metric-icon-wrapper {
            width: 64px;
            height: 64px;
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 12px;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        
        .metric-card:hover .metric-icon-wrapper {
            transform: scale(1.1);
            background: rgba(59, 130, 246, 0.2);
        }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0.75rem 0;
            letter-spacing: -0.025em;
            line-height: 1.2;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .metric-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 600;
            margin-bottom: 0.5rem;
            min-height: 2.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        
        .metric-card small {
            color: var(--text-muted);
            font-size: 0.75rem;
            line-height: 1.4;
            flex-shrink: 0;
            margin-top: auto;
        }
        
        .metric-excellent { color: var(--success-color); }
        .metric-good { color: var(--primary-light); }
        .metric-fair { color: var(--warning-color); }
        .metric-poor { color: var(--danger-color); }
        
        /* Chart Containers */
        .chart-container {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 0.75rem;
            padding: 2rem;
            transition: all 0.3s ease;
            height: 100%;
        }
        
        .chart-container:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
        }
        
        .chart-container h4 {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1.125rem;
        }
        
        .chart-wrapper {
            position: relative;
            height: 300px;
            margin-top: 1rem;
        }
        
        /* Code Tables */
        .code-table {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 0.75rem;
            padding: 2rem;
            max-height: 500px;
            overflow-y: auto;
            transition: all 0.3s ease;
        }
        
        .code-table:hover {
            border-color: var(--primary-color);
        }
        
        .code-table h4 {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1.125rem;
        }
        
        .code-table .border-bottom {
            border-color: var(--card-border) !important;
        }
        
        .code-table.mismatch-details {
            max-height: none;
        }
        
        .mismatch-list {
            max-height: 600px;
            overflow-y: auto;
            padding: 0.5rem 0;
        }
        
        .mismatch-list::-webkit-scrollbar,
        .code-table::-webkit-scrollbar {
            width: 8px;
        }
        
        .mismatch-list::-webkit-scrollbar-track,
        .code-table::-webkit-scrollbar-track {
            background: var(--surface-bg);
            border-radius: 4px;
        }
        
        .mismatch-list::-webkit-scrollbar-thumb,
        .code-table::-webkit-scrollbar-thumb {
            background: var(--card-border);
            border-radius: 4px;
        }
        
        .mismatch-list::-webkit-scrollbar-thumb:hover,
        .code-table::-webkit-scrollbar-thumb:hover {
            background: var(--primary-color);
        }
        
        /* Error Container */
        .error-container {
            animation: fadeInUp 0.4s ease;
            background: var(--card-bg);
            border: 2px solid var(--danger-color);
            border-radius: 0.75rem;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .error-container .error-icon {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .error-message pre {
            background: rgba(248, 113, 113, 0.08);
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 3px solid var(--danger-color);
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin: 0.5rem 0;
        }
        
        /* Download Card */
        .download-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(34, 197, 94, 0.1) 100%);
            border: 2px solid var(--primary-color);
            border-radius: 0.75rem;
            padding: 2rem;
            transition: all 0.3s ease;
            animation: fadeInUp 0.6s;
        }
        
        .download-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(59, 130, 246, 0.2);
            border-color: var(--success-color);
        }
        
        .download-icon-wrapper {
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--success-color), #16a34a);
            border-radius: 12px;
            color: white;
        }
        
        .download-card .btn-success {
            background: linear-gradient(135deg, var(--success-color) 0%, var(--success-dark) 100%);
            border: none;
            transition: all 0.3s ease;
            padding: 0.875rem 2rem;
            font-weight: 600;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }
        
        .download-card .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(34, 197, 94, 0.4);
        }
        
        .download-card .btn-success:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 14, 26, 0.95);
            backdrop-filter: blur(4px);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .loading-overlay > div {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .loading-overlay h3 {
            color: var(--text-primary);
        }
        
        .loading-overlay p {
            color: var(--text-secondary);
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--card-border);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto;
        }
        
        .progress-container {
            width: 100%;
            margin-top: 1.5rem;
        }
        
        .progress-bar {
            transition: width 0.3s ease;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .badge {
            font-weight: 500;
            font-size: 0.75rem;
        }
        
        .badge-depth-1 { background: rgba(239, 68, 68, 0.15); color: #fca5a5; border: 1px solid rgba(239, 68, 68, 0.3); }
        .badge-depth-2 { background: rgba(245, 158, 11, 0.15); color: #fcd34d; border: 1px solid rgba(245, 158, 11, 0.3); }
        .badge-depth-3 { background: rgba(59, 130, 246, 0.15); color: #93c5fd; border: 1px solid rgba(59, 130, 246, 0.3); }
        .badge-depth-4 { background: rgba(34, 197, 94, 0.15); color: #86efac; border: 1px solid rgba(34, 197, 94, 0.3); }
        
        .badge-primary {
            background: rgba(59, 130, 246, 0.15);
            color: var(--accent-blue);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        .badge-secondary {
            background: rgba(107, 114, 128, 0.15);
            color: var(--text-secondary);
            border: 1px solid var(--card-border);
        }
        
        .bg-success {
            background: rgba(34, 197, 94, 0.15) !important;
            color: #86efac !important;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        
        .bg-warning {
            background: rgba(245, 158, 11, 0.15) !important;
            color: #fcd34d !important;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .bg-danger {
            background: rgba(239, 68, 68, 0.15) !important;
            color: #fca5a5 !important;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .alert-custom {
            border-radius: 0.75rem;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
        }
        
        .alert-danger {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            color: var(--text-primary);
        }
        
        .text-muted {
            color: var(--text-muted) !important;
        }
        
        /* Professional Progress Bar Animations */
        @keyframes shine {
            0% {
                left: -100%;
            }
            50% {
                left: 100%;
            }
            100% {
                left: 100%;
            }
        }
        
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="text-center" style="max-width: 500px; margin: 0 auto;">
            <div class="spinner mb-3"></div>
            <h3 id="loadingTitle">Processing...</h3>
            <p id="loadingMessage">Please wait while we process your request. This may take 30-60 seconds.</p>
        </div>
    </div>

    <div class="main-container">
        <!-- Header -->
        <div class="header">
            <h1>AI Coder Evaluation Platform</h1>
            <p>Multi-label classification evaluation for response coding models</p>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation mb-4">
            <div class="nav nav-tabs" role="tablist" style="border-bottom: 2px solid var(--card-border);">
                <button class="nav-link active" id="codeAssignmentTab" data-bs-toggle="tab" data-bs-target="#codeAssignment" type="button" role="tab" style="background: transparent; border: none; color: var(--text-primary); padding: 1rem 2rem; font-weight: 500; cursor: pointer;">
                    <i class="fas fa-code me-2"></i>Code Assignment
                </button>
                <button class="nav-link" id="singleHierarchyTab" data-bs-toggle="tab" data-bs-target="#singleHierarchy" type="button" role="tab" style="background: transparent; border: none; color: var(--text-secondary); padding: 1rem 2rem; font-weight: 500; cursor: pointer;">
                    <i class="fas fa-chart-line me-2"></i>Hierarchy Metrics
                </button>
                <button class="nav-link" id="hierarchyComparisonTab" data-bs-toggle="tab" data-bs-target="#hierarchyComparison" type="button" role="tab" style="background: transparent; border: none; color: var(--text-secondary); padding: 1rem 2rem; font-weight: 500; cursor: pointer;">
                    <i class="fas fa-sitemap me-2"></i>Hierarchy Comparison
                </button>
            </div>
        </div>

        <!-- Tab Content -->
        <div class="tab-content">
            <!-- Code Assignment Tab -->
            <div class="tab-pane fade show active" id="codeAssignment" role="tabpanel">
        <!-- Upload Section -->
        <div class="upload-section">
            <h2 class="mb-4"><i class="fas fa-upload me-2"></i>Upload Model Output</h2>
            
            <!-- Drag & Drop Area -->
            <div class="upload-area" id="uploadArea">
                <i class="fas fa-cloud-upload-alt"></i>
                <h4>Drag & Drop XML File Here</h4>
                <p class="text-muted">or click to browse</p>
                <input type="file" id="fileInput" accept=".xml" style="display: none;">
                <div id="fileInfo" class="mt-3" style="display: none;">
                    <span class="badge bg-primary fs-6">
                        <i class="fas fa-file-code me-2"></i><span id="fileName"></span>
                    </span>
                </div>
            </div>

            <!-- Benchmark Selection -->
            <h3 class="mt-5 mb-3"><i class="fas fa-database me-2"></i>Select Benchmark</h3>
            <div class="benchmark-grid" id="benchmarkGrid">
                {% for id, benchmark in benchmarks.items() %}
                <div class="benchmark-card" data-benchmark="{{ id }}">
                    <h5 class="mb-2">
                        <i class="fas fa-file-alt me-2"></i>{{ benchmark.name }}
                    </h5>
                    <p class="text-muted mb-2" style="font-size: 0.9rem;">{{ benchmark.description }}</p>
                    <small class="badge bg-secondary">{{ benchmark.size }}</small>
                </div>
                {% endfor %}
            </div>

            <!-- Evaluate Button -->
            <div class="text-center mt-4">
                <button class="btn btn-evaluate text-white" id="evaluateBtn" disabled>
                    <i class="fas fa-chart-line me-2"></i>Evaluate Model
                </button>
            </div>
        </div>

        <!-- Results Section -->
        <div class="results-section" id="resultsSection">
            <!-- Results Header -->
            <div class="results-header mb-5">
                <h2 class="mb-2"><i class="fas fa-chart-bar me-2"></i>Evaluation Results</h2>
                <p class="text-muted mb-0">
                    Comprehensive performance metrics and detailed analysis
                    <br><small><i class="fas fa-info-circle me-1"></i><strong>Note:</strong> Only open-ended questions (QuestionType = 0) are analyzed</small>
                </p>
            </div>

            <!-- Main Evaluation: Coding Quality (When Benchmark Has Codes) -->
            <div class="section-group mb-5">
                <h3 class="section-title mb-4">
                    <i class="fas fa-star me-2" style="color: var(--warning-light);"></i>Model Coding Performance
                </h3>
                <div class="alert alert-info mb-4" style="background: rgba(79, 141, 245, 0.08); border-left: 3px solid var(--primary-color); border-radius: 0.5rem;">
                    <i class="fas fa-info-circle me-2" style="color: var(--primary-light);"></i>
                    <strong style="color: var(--text-primary);">Primary Evaluation:</strong> 
                    <span style="color: var(--text-secondary);">Metrics below evaluate model performance <strong>only for responses where the benchmark has codes assigned</strong>.
                    This measures how accurately the model codes responses that should have codes.</span>
                </div>
                <div class="row g-4">
                    <div class="col-lg-3 col-md-6">
                        <div class="metric-card metric-primary text-center">
                            <div class="metric-icon-wrapper">
                                <i class="fas fa-bullseye fa-2x" style="color: var(--primary-light);"></i>
                            </div>
                            <div class="metric-label">F1-Score</div>
                            <div class="metric-value" id="f1Micro">-</div>
                            <small class="text-muted" id="f1MicroLabel">Micro-averaged • Overall performance</small>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="metric-card metric-primary text-center">
                            <div class="metric-icon-wrapper">
                                <i class="fas fa-crosshairs fa-2x" style="color: var(--success-light);"></i>
                            </div>
                            <div class="metric-label">Precision</div>
                            <div class="metric-value" id="precision">-</div>
                            <small class="text-muted">Micro-averaged • Indicator for overcoding</small>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="metric-card metric-primary text-center">
                            <div class="metric-icon-wrapper">
                                <i class="fas fa-clipboard-check fa-2x" style="color: var(--primary-light);"></i>
                            </div>
                            <div class="metric-label">Recall</div>
                            <div class="metric-value" id="recall">-</div>
                            <small class="text-muted">Micro-averaged • Indicator for undercoding</small>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="metric-card metric-primary text-center">
                            <div class="metric-icon-wrapper">
                                <i class="fas fa-check-double fa-2x" style="color: var(--warning-light);"></i>
                            </div>
                            <div class="metric-label">Exact Match</div>
                            <div class="metric-value" id="exactMatch">-</div>
                            <small class="text-muted">Perfect predictions • All codes match exactly</small>
                        </div>
                    </div>
                </div>
                
                <!-- Secondary Row - Additional Context -->
                <div class="row g-4 mt-3">
                    <div class="col-lg-4 col-md-6">
                        <div class="metric-card text-center" style="border-left: 3px solid var(--text-muted);">
                            <div class="metric-icon-wrapper">
                                <i class="fas fa-project-diagram fa-2x" style="color: var(--text-muted);"></i>
                            </div>
                            <div class="metric-label">Jaccard Similarity</div>
                            <div class="metric-value" id="jaccard">-</div>
                            <small class="text-muted">Average overlap • Code overlap ratio</small>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-6">
                        <div class="metric-card text-center" style="border-left: 3px solid var(--text-muted);">
                            <div class="metric-icon-wrapper">
                                <i class="fas fa-list-ol fa-2x" style="color: var(--text-muted);"></i>
                            </div>
                            <div class="metric-label">Coded Responses</div>
                            <div class="metric-value" id="nCodedResponses">-</div>
                            <small class="text-muted">Where benchmark has codes</small>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-6">
                        <div class="metric-card text-center" style="border-left: 3px solid var(--text-muted);">
                            <div class="metric-icon-wrapper">
                                <i class="fas fa-layer-group fa-2x" style="color: var(--text-muted);"></i>
                            </div>
                            <div class="metric-label">F1-Score (Macro)</div>
                            <div class="metric-value" id="f1Macro">-</div>
                            <small class="text-muted">Per-code average • Equal weight to all codes</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Uncoded Classification Performance (Separate Evaluation) -->
            <div class="section-group mb-5" id="uncodedClassificationSection" style="display: none;">
                <h3 class="section-title mb-4">
                    <i class="fas fa-question-circle me-2" style="color: var(--warning-light);"></i>Uncoded Classification Performance
                </h3>
                <div class="alert alert-warning mb-4" style="background: rgba(245, 158, 11, 0.08); border-left: 3px solid var(--warning-color); border-radius: 0.5rem;">
                    <i class="fas fa-info-circle me-2" style="color: var(--warning-light);"></i>
                    <strong style="color: var(--text-primary);">Separate Evaluation:</strong> 
                    <span style="color: var(--text-secondary);">This measures how well the model identifies when responses should have <strong>no codes assigned</strong>.
                    This is evaluated separately from coding quality above.</span>
                </div>
                <div class="row g-4">
                    <div class="col-lg-3 col-md-6">
                        <div class="metric-card text-center" style="border-left: 4px solid var(--success-color);">
                            <div class="metric-icon-wrapper">
                                <i class="fas fa-check-circle fa-2x" style="color: var(--success-light);"></i>
                            </div>
                            <div class="metric-label">Overlap</div>
                            <div class="metric-value" id="uncodedOverlapCount">0</div>
                            <small class="text-muted" id="uncodedOverlapPct">0%</small>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="metric-card text-center" style="border-left: 4px solid var(--primary-color);">
                            <div class="metric-icon-wrapper">
                                <i class="fas fa-bullseye fa-2x" style="color: var(--primary-light);"></i>
                            </div>
                            <div class="metric-label">Classification Accuracy</div>
                            <div class="metric-value" id="uncodedClassificationAccuracy">-</div>
                            <small class="text-muted">Correctly identified as uncoded</small>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="metric-card text-center" style="border-left: 4px solid var(--danger-color);">
                            <div class="metric-icon-wrapper">
                                <i class="fas fa-exclamation-triangle fa-2x" style="color: var(--danger-light);"></i>
                            </div>
                            <div class="metric-label">Incorrectly Coded</div>
                            <div class="metric-value" id="incorrectlyCodedCount">0</div>
                            <small class="text-muted">Model coded when shouldn't</small>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="metric-card text-center" style="border-left: 4px solid var(--warning-color);">
                            <div class="metric-icon-wrapper">
                                <i class="fas fa-file-alt fa-2x" style="color: var(--warning-light);"></i>
                            </div>
                            <div class="metric-label">Benchmark Uncoded</div>
                            <div class="metric-value" id="uncodedBenchmarkTotal">0</div>
                            <small class="text-muted">Total uncoded cases</small>
                        </div>
                    </div>
                </div>
                
                <!-- Show examples of incorrectly coded responses -->
                <div id="incorrectlyCodedExamples" class="mt-4" style="display: none;">
                    <h5 class="mb-3" style="color: var(--text-primary);">
                        <i class="fas fa-list me-2"></i>Examples: Responses Incorrectly Coded (Model assigned codes when benchmark is uncoded)
                    </h5>
                    <div class="table-responsive">
                        <table class="table table-sm" style="background: var(--card-bg); font-size: 0.9rem;">
                            <thead style="background: rgba(248, 113, 113, 0.08);">
                                <tr>
                                    <th>Respondent ID</th>
                                    <th>Question ID</th>
                                    <th>Assigned Codes</th>
                                    <th>Count</th>
                                </tr>
                            </thead>
                            <tbody id="incorrectlyCodedTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Question-Level Uncoded Breakdown Section -->
            <div class="section-group mb-5" id="questionUncodedSection" style="display: none;">
                <h3 class="section-title mb-4">
                    <i class="fas fa-table me-2" style="color: var(--accent-indigo);"></i>Question-Level Uncoded Breakdown
                </h3>
                <div class="alert alert-info mb-3" style="background: rgba(99, 102, 241, 0.08); border-left: 3px solid var(--accent-indigo); border-radius: 0.5rem;">
                    <i class="fas fa-info-circle me-2" style="color: var(--accent-purple-light);"></i>
                    <strong style="color: var(--text-primary);">Overlap Analysis:</strong> 
                    <span style="color: var(--text-secondary);">Shows how many responses are uncoded in both benchmark and model output for each question.
                    Higher overlap indicates better agreement on which responses should remain uncoded.</span>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover table-dark-grid" style="background: var(--card-bg); border-radius: 0.5rem; overflow: hidden; border-collapse: separate; border-spacing: 0;">
                        <thead style="border-bottom: 2px solid var(--card-border);">
                            <tr>
                                <th style="color: var(--text-secondary); font-weight: 700; padding: 1rem 0.75rem; font-size: 0.875rem; letter-spacing: 0.025em; text-transform: uppercase;">Question ID</th>
                                <th style="color: var(--text-secondary); font-weight: 700; padding: 1rem 0.75rem; font-size: 0.875rem; letter-spacing: 0.025em; text-transform: uppercase;" class="text-center">Total</th>
                                <th style="color: var(--text-secondary); font-weight: 700; padding: 1rem 0.75rem; font-size: 0.875rem; letter-spacing: 0.025em;" class="text-center">
                                    <span class="badge" style="background: rgba(242, 178, 102, 0.18); color: var(--warning-light); padding: 0.4rem 0.75rem; border: 1px solid rgba(242, 178, 102, 0.35); border-radius: 0.5rem; font-weight: 600; font-size: 0.75rem; line-height: 1.3; display: inline-block; box-shadow: none;">Benchmark<br/>Uncoded</span>
                                </th>
                                <th style="color: var(--text-secondary); font-weight: 700; padding: 1rem 0.75rem; font-size: 0.875rem; letter-spacing: 0.025em;" class="text-center">
                                    <span class="badge" style="background: rgba(241, 115, 115, 0.18); color: var(--danger-light); padding: 0.4rem 0.75rem; border: 1px solid rgba(241, 115, 115, 0.35); border-radius: 0.5rem; font-weight: 600; font-size: 0.75rem; line-height: 1.3; display: inline-block; box-shadow: none;">Model<br/>Uncoded</span>
                                </th>
                                <th style="color: var(--text-secondary); font-weight: 700; padding: 1rem 0.75rem; font-size: 0.875rem; letter-spacing: 0.025em;" class="text-center">
                                    <span class="badge" style="background: rgba(16, 185, 129, 0.18); color: var(--success-light); padding: 0.4rem 0.75rem; border: 1px solid rgba(16, 185, 129, 0.35); border-radius: 0.5rem; font-weight: 600; font-size: 0.75rem; line-height: 1.3; display: inline-block; box-shadow: none;">Both<br/>Uncoded</span>
                                </th>
                                <th style="color: var(--text-secondary); font-weight: 700; padding: 1rem 0.75rem; font-size: 0.875rem; letter-spacing: 0.025em; text-transform: uppercase;" class="text-center">Overlap %</th>
                                <th style="color: #475569; font-weight: 700; padding: 1rem 0.75rem; font-size: 0.875rem; letter-spacing: 0.025em; text-transform: uppercase;" class="text-center">Accuracy</th>
                            </tr>
                        </thead>
                        <tbody id="questionUncodedTableBody">
                            <!-- Table rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Download Section - Prominent -->
            <div class="section-group mb-5" id="downloadSection" style="display: none;">
                <div class="download-card">
                    <div class="row align-items-center g-4">
                        <div class="col-lg-8">
                            <div class="d-flex align-items-center mb-3">
                                <div class="download-icon-wrapper me-3">
                                    <i class="fas fa-file-csv fa-2x"></i>
                                </div>
                                <div>
                                    <h4 class="mb-1" style="color: var(--text-primary); font-weight: 600;">
                                        Download Complete Mismatch Report
                                    </h4>
                                    <p class="text-muted mb-0 small">
                                        <i class="fas fa-info-circle me-1"></i>Available immediately after evaluation
                                    </p>
                                </div>
                            </div>
                            <p class="mb-0" style="color: var(--text-secondary); line-height: 1.6;">
                                Export all mismatched responses as a CSV file with verbatim text, missed codes, extra codes, and detailed analysis for further review and improvement.
                            </p>
                        </div>
                        <div class="col-lg-4 text-lg-end">
                            <button class="btn btn-lg btn-success w-100 w-lg-auto" id="downloadCsvBtn" disabled>
                                <i class="fas fa-download me-2"></i>Download CSV
                            </button>
                            <div id="downloadStatus" class="mt-2 small text-muted" style="display: none;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Visualizations Section -->
            <div class="section-group mb-5">
                <h3 class="section-title mb-4">
                    <i class="fas fa-chart-area me-2" style="color: var(--primary-color);"></i>Visualizations
                </h3>
                <div class="row g-4">
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <div class="d-flex align-items-center justify-content-between mb-3">
                                <h4 class="mb-0">
                                    <i class="fas fa-chart-pie me-2"></i>Performance Overview
                                </h4>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="metricsChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <div class="d-flex align-items-center justify-content-between mb-3">
                                <h4 class="mb-0">
                                    <i class="fas fa-signal me-2"></i>Confusion Matrix
                                </h4>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="confusionChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Code Performance Analysis -->
            <div class="section-group mb-5">
                <h3 class="section-title mb-4">
                    <i class="fas fa-code me-2" style="color: var(--primary-color);"></i>Code Performance Analysis
                </h3>
                <div class="row g-4">
                    <div class="col-lg-6">
                        <div class="code-table">
                            <div class="d-flex align-items-center mb-3">
                                <i class="fas fa-arrow-up me-2" style="color: var(--success-light); font-size: 1.25rem;"></i>
                                <h4 class="mb-0">Top 10 Performing Codes</h4>
                            </div>
                            <div id="topCodes"></div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="code-table">
                            <div class="d-flex align-items-center mb-3">
                                <i class="fas fa-arrow-down me-2" style="color: #f87171; font-size: 1.25rem;"></i>
                                <h4 class="mb-0">Bottom 10 Performing Codes</h4>
                            </div>
                            <div id="bottomCodes"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mismatch Details Section -->
            <div class="section-group mb-5" id="mismatchSection" style="display: none;">
                <h3 class="section-title mb-3">
                    <i class="fas fa-exclamation-triangle me-2" style="color: var(--warning-color);"></i>Top Mismatches
                </h3>
                <div class="code-table mismatch-details" style="padding: 1.5rem;">
                    <div class="mb-3">
                        <h5 class="mb-1" id="mismatchTitle">Mismatched Responses</h5>
                        <small class="text-muted">
                            <span class="badge bg-danger me-1">❌ Missed</span> = Should have predicted | 
                            <span class="badge bg-warning text-dark me-1">⚠️ Extra</span> = Should NOT have predicted
                        </small>
                    </div>
                    <div id="worstMismatches" class="mismatch-list">                    </div>
                </div>
            </div>
        </div>
            </div>
            <!-- End Code Assignment Tab -->

            <!-- Single Hierarchy Metrics Tab -->
            <div class="tab-pane fade" id="singleHierarchy" role="tabpanel">
                <div class="upload-section">
                    <h2 class="mb-4"><i class="fas fa-chart-line me-2"></i>Hierarchy Metrics</h2>
                    <p class="text-muted mb-4">Calculate semantic metrics for a single hierarchy XML file.</p>
                    
                    <div class="row g-4">
                        <div class="col-md-12">
                            <h3 class="mb-3"><i class="fas fa-file-code me-2"></i>Upload Hierarchy XML</h3>
                            <div class="upload-area" id="singleHierarchyUpload" style="max-width: 600px; margin: 0 auto;">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <h4>Drag & Drop Hierarchy XML</h4>
                                <p class="text-muted">or click to browse</p>
                                <input type="file" id="singleHierarchyInput" accept=".xml" style="display: none;">
                                <div id="singleHierarchyInfo" class="mt-3" style="display: none;">
                                    <span class="badge bg-primary fs-6">
                                        <i class="fas fa-file-code me-2"></i><span id="singleHierarchyFileName"></span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-4">
                        <button class="btn btn-evaluate text-white" id="evaluateSingleHierarchyBtn" disabled>
                            <i class="fas fa-calculator me-2"></i>Calculate Metrics
                        </button>
                    </div>
                </div>

                <div class="results-section" id="singleHierarchyResultsSection" style="display: none;">
                    <div class="results-header mb-5">
                        <h2 class="mb-2"><i class="fas fa-chart-bar me-2"></i>Hierarchy Metrics Results</h2>
                    </div>

                    <div class="section-group mb-5">
                        <h3 class="section-title mb-4">
                            <i class="fas fa-chart-bar me-2"></i>Semantic Metrics
                        </h3>
                        
                        <!-- Row 1: Core Similarity & Coherence Metrics -->
                        <div class="row g-4 mb-4">
                            <div class="col-lg-3 col-md-6">
                                <div class="metric-card text-center">
                                    <div class="metric-icon-wrapper">
                                        <i class="fas fa-magnet fa-2x" style="color: var(--primary-light);"></i>
                                    </div>
                                    <div class="metric-label">Embedding Coherence</div>
                                    <div class="metric-value" id="singleEmbeddingCoherence">-</div>
                                    <small class="text-muted">Within subtopics (≥0.75 good)</small>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <div class="metric-card text-center">
                                    <div class="metric-icon-wrapper">
                                        <i class="fas fa-sitemap fa-2x" style="color: var(--success-light);"></i>
                                    </div>
                                    <div class="metric-label">Parent–Child Similarity</div>
                                    <div class="metric-value" id="singleParentChildSimilarity">-</div>
                                    <small class="text-muted">Mean cosine similarity</small>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <div class="metric-card text-center">
                                    <div class="metric-icon-wrapper">
                                        <i class="fas fa-filter fa-2x" style="color: var(--success-light);"></i>
                                    </div>
                                    <div class="metric-label">Net Purity (Content)</div>
                                    <div class="metric-value" id="singleNetPurity">-</div>
                                    <small class="text-muted">Parent label vs child documents</small>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <div class="metric-card text-center metric-primary">
                                    <div class="metric-icon-wrapper">
                                        <i class="fas fa-star fa-2x" style="color: var(--warning-color);"></i>
                                    </div>
                                    <div class="metric-label">Composite Quality Score</div>
                                    <div class="metric-value" id="singleCompositeQualityScore">-</div>
                                    <small class="text-muted">Overall hierarchy quality (0-1)</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Row 2: Diversity & Duplication Metrics -->
                        <div class="row g-4">
                            <div class="col-lg-3 col-md-6">
                                <div class="metric-card text-center">
                                    <div class="metric-icon-wrapper">
                                        <i class="fas fa-layer-group fa-2x" style="color: var(--accent-purple-light);"></i>
                                    </div>
                                    <div class="metric-label">Intra-Level Diversity</div>
                                    <div class="metric-value" id="singleIntraLevelDiversity">-</div>
                                    <small class="text-muted">1 - mean cosine (higher=better)</small>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <div class="metric-card text-center">
                                    <div class="metric-icon-wrapper">
                                        <i class="fas fa-chart-area fa-2x" style="color: var(--accent-indigo);"></i>
                                    </div>
                                    <div class="metric-label">Inter-Level Granularity</div>
                                    <div class="metric-value" id="singleInterLevelGranularity">-</div>
                                    <small class="text-muted">Parent-child - Sibling Δ</small>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <div class="metric-card text-center">
                                    <div class="metric-icon-wrapper">
                                        <i class="fas fa-exclamation-triangle fa-2x" style="color: var(--warning-light);"></i>
                                    </div>
                                    <div class="metric-label">Local Duplicate Penalty</div>
                                    <div class="metric-value" id="singleLocalDuplicatePenalty">-</div>
                                    <small class="text-muted">Sibling pairs >0.85 (≤0.10 good)</small>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <div class="metric-card text-center">
                                    <div class="metric-icon-wrapper">
                                        <i class="fas fa-exclamation-circle fa-2x" style="color: var(--danger-light);"></i>
                                    </div>
                                    <div class="metric-label">Global Duplicate Penalty</div>
                                    <div class="metric-value" id="singleGlobalDuplicatePenalty">-</div>
                                    <small class="text-muted">Level pairs >0.85 (≤0.15 good)</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="section-group mb-5">
                        <h3 class="section-title mb-4">
                            <i class="fas fa-info-circle me-2"></i>Hierarchy Statistics
                        </h3>
                        <div class="row g-4">
                            <div class="col-md-12">
                                <div class="chart-container">
                                    <h4 class="mb-3">Hierarchy Tree</h4>
                                    <div id="singleHierarchyTree" style="background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 0.5rem; padding: 1.5rem; min-height: 400px; overflow-x: auto; font-family: 'Courier New', monospace; font-size: 0.9rem; color: var(--text-primary);"></div>
                                </div>
                            </div>
                        </div>
                        <div class="row g-4 mt-3">
                            <div class="col-md-4">
                                <div class="metric-card text-center">
                                    <div class="metric-label">Total Codes</div>
                                    <div class="metric-value" id="singleTotalCodes">-</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="metric-card text-center">
                                    <div class="metric-label">Max Depth</div>
                                    <div class="metric-value" id="singleMaxDepth">-</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="metric-card text-center">
                                    <div class="metric-label">Codes with Documents</div>
                                    <div class="metric-value" id="singleCodesWithDocuments">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Coverage Statistics Section -->
                    <div class="section-group mb-5" id="coverageStatsSection" style="display: none;">
                        <h3 class="section-title mb-4">
                            <i class="fas fa-chart-pie me-2"></i>Data Coverage Statistics
                        </h3>
                        <div class="row g-4">
                            <div class="col-md-12">
                                <div class="chart-container">
                                    <p class="text-muted mb-3">These statistics show what fraction of the hierarchy was included in each metric calculation.</p>
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <div class="metric-card">
                                                <div class="metric-label">Codes with Descriptions</div>
                                                <div class="metric-value" id="coverageDescriptions" style="font-size: 1.5rem;">-</div>
                                                <small class="text-muted">Required for label-based metrics</small>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="metric-card">
                                                <div class="metric-label">Codes with Documents</div>
                                                <div class="metric-value" id="coverageDocuments" style="font-size: 1.5rem;">-</div>
                                                <small class="text-muted">Required for content-based metrics</small>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="metric-card">
                                                <div class="metric-label">Coherence Coverage</div>
                                                <div class="metric-value" id="coverageCoherence" style="font-size: 1.5rem;">-</div>
                                                <small class="text-muted">Codes with 2+ documents (single-doc excluded)</small>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="metric-card">
                                                <div class="metric-label">Parent-Child Coverage</div>
                                                <div class="metric-value" id="coverageParentChild" style="font-size: 1.5rem;">-</div>
                                                <small class="text-muted">Pairs with both descriptions</small>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="metric-card">
                                                <div class="metric-label">Net Purity Coverage</div>
                                                <div class="metric-value" id="coverageNetPurity" style="font-size: 1.5rem;">-</div>
                                                <small class="text-muted">Pairs with parent label + child documents</small>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="metric-card">
                                                <div class="metric-label">Single-Document Codes</div>
                                                <div class="metric-value" id="coverageSingleDoc" style="font-size: 1.5rem;">-</div>
                                                <small class="text-muted">Excluded from coherence (always = 1.0)</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hierarchy Comparison Tab -->
            <div class="tab-pane fade" id="hierarchyComparison" role="tabpanel">
                <div class="upload-section">
                    <h2 class="mb-4"><i class="fas fa-sitemap me-2"></i>Hierarchy Comparison</h2>
                    <p class="text-muted mb-4">Compare two hierarchy XML files side-by-side (structure visualization only).</p>
                    
                    <div class="row g-4">
                        <!-- Benchmark Upload -->
                        <div class="col-md-6">
                            <h3 class="mb-3"><i class="fas fa-database me-2"></i>Benchmark XML</h3>
                            <div class="upload-area" id="benchmarkHierarchyUpload">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <h4>Drag & Drop Benchmark XML</h4>
                                <p class="text-muted">or click to browse</p>
                                <input type="file" id="benchmarkHierarchyInput" accept=".xml" style="display: none;">
                                <div id="benchmarkHierarchyInfo" class="mt-3" style="display: none;">
                                    <span class="badge bg-primary fs-6">
                                        <i class="fas fa-file-code me-2"></i><span id="benchmarkHierarchyFileName"></span>
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Model Upload -->
                        <div class="col-md-6">
                            <h3 class="mb-3"><i class="fas fa-robot me-2"></i>Model Output XML</h3>
                            <div class="upload-area" id="modelHierarchyUpload">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <h4>Drag & Drop Model XML</h4>
                                <p class="text-muted">or click to browse</p>
                                <input type="file" id="modelHierarchyInput" accept=".xml" style="display: none;">
                                <div id="modelHierarchyInfo" class="mt-3" style="display: none;">
                                    <span class="badge bg-success fs-6">
                                        <i class="fas fa-file-code me-2"></i><span id="modelHierarchyFileName"></span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Evaluate Button -->
                    <div class="text-center mt-4">
                        <button class="btn btn-evaluate text-white" id="evaluateHierarchyBtn" disabled>
                            <i class="fas fa-balance-scale me-2"></i>Compare Hierarchies
                        </button>
                    </div>
                </div>

                <!-- Hierarchy Results Section -->
                <div class="results-section" id="hierarchyResultsSection" style="display: none;">
                    <div class="results-header mb-5">
                        <h2 class="mb-2"><i class="fas fa-sitemap me-2"></i>Hierarchy Comparison</h2>
                    </div>

                    <!-- Side-by-Side Hierarchy Trees -->
                    <div class="section-group mb-5">
                        <h3 class="section-title mb-4">
                            <i class="fas fa-sitemap me-2"></i>Hierarchy Structures
                        </h3>
                        <div class="row g-4">
                            <div class="col-md-6">
                                <div class="chart-container">
                                    <h4 class="mb-3">Benchmark Hierarchy</h4>
                                    <div id="benchmarkTree" style="background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 0.5rem; padding: 1.5rem; min-height: 400px; overflow-x: auto; font-family: 'Courier New', monospace; font-size: 0.9rem; color: var(--text-primary);"></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="chart-container">
                                    <h4 class="mb-3">Model Hierarchy</h4>
                                    <div id="modelTree" style="background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 0.5rem; padding: 1.5rem; min-height: 400px; overflow-x: auto; font-family: 'Courier New', monospace; font-size: 0.9rem; color: var(--text-primary);"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Hierarchy Tab -->
        </div>
        <!-- End Tab Content -->
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let selectedFile = null;
        let selectedBenchmark = null;
        let metricsChart = null;
        let confusionChart = null;

        // File Upload Handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');

        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                handleFileSelect();
            }
        });
        
        fileInput.addEventListener('change', handleFileSelect);

        function handleFileSelect() {
            if (fileInput.files.length > 0) {
                selectedFile = fileInput.files[0];
                fileName.textContent = selectedFile.name;
                fileInfo.style.display = 'block';
                checkReadyToEvaluate();
            }
        }

        // Benchmark Selection
        document.querySelectorAll('.benchmark-card').forEach(card => {
            card.addEventListener('click', function() {
                document.querySelectorAll('.benchmark-card').forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
                selectedBenchmark = this.dataset.benchmark;
                checkReadyToEvaluate();
            });
        });

        function checkReadyToEvaluate() {
            const btn = document.getElementById('evaluateBtn');
            btn.disabled = !(selectedFile && selectedBenchmark);
        }

        // Evaluate Button
        document.getElementById('evaluateBtn').addEventListener('click', async () => {
            if (!selectedFile || !selectedBenchmark) return;

            // Check file size (16MB limit for Render free tier)
            const maxSize = 16 * 1024 * 1024; // 16MB
            if (selectedFile.size > maxSize) {
                alert(`File too large! Maximum size is 16MB. Your file is ${(selectedFile.size / 1024 / 1024).toFixed(1)}MB.`);
                return;
            }

            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('benchmark', selectedBenchmark);

            // Show loading overlay
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingTitle = document.getElementById('loadingTitle');
            const loadingMessage = document.getElementById('loadingMessage');
            
            loadingOverlay.classList.add('active');
            loadingTitle.textContent = 'Evaluating Model...';
            loadingMessage.textContent = 'Comparing model output against benchmark. This may take 30-60 seconds.';

            try {
                const response = await fetch('/api/evaluate', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok || data.error) {
                    showPageError(
                        data.error || 'Evaluation Failed',
                        data.message || 'An error occurred during evaluation.',
                        data.suggestion || 'Please check your file format and try again.'
                    );
                    loadingOverlay.classList.remove('active');
                    return;
                }

                // Results are returned directly - no polling needed
                loadingOverlay.classList.remove('active');
                displayResults(data);
                
            } catch (error) {
                let errorTitle = 'Evaluation Failed';
                let errorMsg = '';
                let suggestion = '';
                
                if (error.name === 'AbortError' || error.message.includes('timeout')) {
                    errorMsg = 'Request timeout! The evaluation took too long.';
                    suggestion = 'Try with a smaller file or simpler benchmark.';
                } else if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
                    errorMsg = 'Network error! Unable to connect to the server.';
                    suggestion = 'Check if the server is running and try again.';
                } else {
                    errorMsg = error.message || 'An unexpected error occurred.';
                    suggestion = 'Please check your file format and try again.';
                }
                
                console.error('[ERROR] Evaluation error:', error);
                showPageError(errorTitle, errorMsg, suggestion);
                loadingOverlay.classList.remove('active');
            }
        });

        // Function to display errors on the page instead of alert dialogs
        function showPageError(title, message, suggestion = '') {
            const resultsSection = document.getElementById('resultsSection');
            
            // Build error HTML with better styling
            let errorHtml = `
                <div class="error-container" style="background: var(--card-bg); border: 2px solid var(--danger-color); border-radius: 0.75rem; padding: 2rem; margin-bottom: 2rem;">
                    <div class="d-flex align-items-start mb-3">
                        <div class="error-icon me-3" style="font-size: 2rem; color: var(--danger-color);">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div style="flex: 1;">
                            <h3 class="mb-2" style="color: var(--danger-color); font-weight: 600;">
                                ${title}
                            </h3>
                            <div class="error-message" style="color: var(--text-secondary); line-height: 1.6; margin-bottom: 1rem;">
                                ${message.includes('\n') ? `<pre style="white-space: pre-wrap; font-size: 0.9rem; background: rgba(248, 113, 113, 0.08); padding: 1rem; border-radius: 0.5rem; border-left: 3px solid var(--danger-color);">${message}</pre>` : message}
                            </div>
                            ${suggestion ? `
                                <div class="error-suggestion" style="background: rgba(251, 191, 36, 0.08); border-left: 3px solid var(--warning-light); padding: 1rem; border-radius: 0.25rem; margin-top: 1rem;">
                                    <strong style="color: var(--warning-light);"><i class="fas fa-lightbulb me-2"></i>Suggestion:</strong>
                                    <div style="color: var(--text-secondary); margin-top: 0.5rem;">${suggestion}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    <div class="text-end">
                        <button class="btn btn-primary" onclick="document.getElementById('resultsSection').style.display='none'; document.getElementById('resultsSection').innerHTML='';">
                            <i class="fas fa-times me-2"></i>Dismiss
                        </button>
                    </div>
                </div>
            `;
            
            resultsSection.innerHTML = errorHtml;
            resultsSection.style.display = 'block';
            resultsSection.classList.add('active');
            resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function displayResults(data) {
            console.log('[DEBUG] displayResults called with:', data);
            
            if (!data || !data.overall) {
                throw new Error('Invalid response data: missing overall metrics');
            }
            
            const results = data.overall;
            
            try {
                // Update main evaluation metrics (coded responses only)
                const codedOnly = results.coded_only || {};
                
                if (codedOnly.f1_micro !== undefined) updateMetric('f1Micro', codedOnly.f1_micro, 'f1MicroLabel');
                if (codedOnly.precision_micro !== undefined) updateMetric('precision', codedOnly.precision_micro);
                if (codedOnly.recall_micro !== undefined) updateMetric('recall', codedOnly.recall_micro);
                if (codedOnly.exact_match_ratio !== undefined) updateMetric('exactMatch', codedOnly.exact_match_ratio, null, true);
                if (codedOnly.jaccard_mean !== undefined) updateMetric('jaccard', codedOnly.jaccard_mean);
                if (codedOnly.n_responses !== undefined) {
                    document.getElementById('nCodedResponses').textContent = codedOnly.n_responses.toLocaleString();
                }
                
                // F1 Macro (using overall since it's per-code)
                if (results.f1_macro !== undefined) updateMetric('f1Macro', results.f1_macro);
                
                // Total responses for context
                if (results.n_responses !== undefined) {
                    const nResponsesEl = document.getElementById('nResponses');
                    if (nResponsesEl) {
                        nResponsesEl.textContent = results.n_responses.toLocaleString();
                    }
                }

                // Display new metrics
                if (results.f1_macro_weighted !== undefined) updateMetric('f1MacroWeighted', results.f1_macro_weighted);
                if (results.hamming_loss !== undefined) {
                    const hammingLossEl = document.getElementById('hammingLoss');
                    if (hammingLossEl) {
                        hammingLossEl.textContent = results.hamming_loss.toFixed(4);
                        hammingLossEl.style.color = results.hamming_loss < 0.1 ? 'var(--success-color)' : (results.hamming_loss < 0.3 ? 'var(--warning-color)' : 'var(--danger-color)');
                    }
                }

                // Display coded responses only metrics
                if (results.coded_only && results.coded_only.n_responses > 0) {
                    const codedSection = document.getElementById('codedOnlySection');
                    const coded = results.coded_only;
                    
                    if (codedSection) {
                        codedSection.style.display = 'block';
                        
                        if (coded.exact_match_ratio !== undefined) {
                            const exactMatchEl = document.getElementById('codedExactMatch');
                            if (exactMatchEl) {
                                exactMatchEl.textContent = (coded.exact_match_ratio * 100).toFixed(1) + '%';
                            }
                        }
                        
                        if (coded.n_responses !== undefined) {
                            const nResponsesEl = document.getElementById('codedNResponses');
                            if (nResponsesEl) {
                                nResponsesEl.textContent = `${coded.n_responses.toLocaleString()} coded responses`;
                            }
                        }
                        
                        if (coded.jaccard_mean !== undefined) updateMetric('codedJaccard', coded.jaccard_mean);
                        if (coded.f1_micro !== undefined) updateMetric('codedF1', coded.f1_micro);
                        if (coded.precision_micro !== undefined) updateMetric('codedPrecision', coded.precision_micro);
                    }
                } else {
                    const codedSection = document.getElementById('codedOnlySection');
                    if (codedSection) codedSection.style.display = 'none';
                }

                // Display uncoded classification performance (separate evaluation)
                const uncodedClfSection = document.getElementById('uncodedClassificationSection');
                if (results.uncoded_classification && results.uncoded_classification.total_cases > 0) {
                    const uncodedClf = results.uncoded_classification;
                    
                    if (uncodedClfSection) {
                        uncodedClfSection.style.display = 'block';
                        
                        // Overlap
                        if (uncodedClf.overlap_count !== undefined) {
                            document.getElementById('uncodedOverlapCount').textContent = uncodedClf.overlap_count.toLocaleString();
                        }
                        if (uncodedClf.overlap_percentage !== undefined) {
                            document.getElementById('uncodedOverlapPct').textContent = uncodedClf.overlap_percentage.toFixed(1) + '%';
                        }
                        
                        // Classification accuracy
                        if (uncodedClf.accuracy !== undefined) {
                            updateMetric('uncodedClassificationAccuracy', uncodedClf.accuracy);
                        }
                        
                        // Incorrectly coded (model coded when shouldn't)
                        if (uncodedClf.false_positives !== undefined) {
                            document.getElementById('incorrectlyCodedCount').textContent = uncodedClf.false_positives.toLocaleString();
                        }
                        
                        // Total benchmark uncoded
                        if (uncodedClf.total_cases !== undefined) {
                            document.getElementById('uncodedBenchmarkTotal').textContent = uncodedClf.total_cases.toLocaleString();
                        }
                        
                        // Show examples of incorrectly coded responses
                        if (uncodedClf.incorrectly_coded_responses && uncodedClf.incorrectly_coded_responses.length > 0) {
                            const examplesDiv = document.getElementById('incorrectlyCodedExamples');
                            const tableBody = document.getElementById('incorrectlyCodedTableBody');
                            
                            if (examplesDiv && tableBody) {
                                examplesDiv.style.display = 'block';
                                tableBody.innerHTML = '';
                                
                                uncodedClf.incorrectly_coded_responses.slice(0, 10).forEach(item => {
                                    const row = document.createElement('tr');
                                    row.innerHTML = `
                                        <td>${item.respondent_id}</td>
                                        <td>${item.question_id}</td>
                                        <td><span class="badge bg-warning text-dark">${item.assigned_codes.join(', ')}</span></td>
                                        <td class="text-center">${item.assigned_code_count}</td>
                                    `;
                                    tableBody.appendChild(row);
                                });
                                
                                if (uncodedClf.incorrectly_coded_responses.length > 10) {
                                    const row = document.createElement('tr');
                                    row.innerHTML = `
                                        <td colspan="4" class="text-center text-muted">
                                            ... and ${uncodedClf.incorrectly_coded_responses.length - 10} more (see CSV for full list)
                                        </td>
                                    `;
                                    tableBody.appendChild(row);
                                }
                            }
                        }
                    }
                } else if (uncodedClfSection) {
                    uncodedClfSection.style.display = 'none';
                }

                // Display question-level uncoded breakdown
                if (results.question_uncoded_breakdown && results.question_uncoded_breakdown.length > 0) {
                    // Filter to only show questions with uncoded responses
                    const questionsWithUncoded = results.question_uncoded_breakdown.filter(q => 
                        q.benchmark_uncoded > 0 || q.model_uncoded > 0 || q.both_uncoded > 0
                    );
                    
                    const questionSection = document.getElementById('questionUncodedSection');
                    const tableBody = document.getElementById('questionUncodedTableBody');
                    
                    if (questionSection && tableBody) {
                        if (questionsWithUncoded.length > 0) {
                            // Show section if there are questions with uncoded responses
                            questionSection.style.display = 'block';
                            tableBody.innerHTML = '';
                            const noUncodedMsg = document.getElementById('noUncodedMessage');
                            if (noUncodedMsg) noUncodedMsg.style.display = 'none';
                            
                            questionsWithUncoded.forEach((q, idx) => {
                                const row = document.createElement('tr');
                                row.style.borderBottom = '1px solid var(--card-border)';
                                
                                // Highlight rows with high overlap
                                const overlapPct = q.overlap_percentage || 0;
                                if (overlapPct >= 80 && q.both_uncoded > 0) {
                                    row.style.background = 'rgba(16, 185, 129, 0.04)';
                                } else if (overlapPct < 50 && (q.benchmark_uncoded > 0 || q.model_uncoded > 0)) {
                                    row.style.background = 'rgba(248, 113, 113, 0.04)';
                                }
                                
                                // Calculate accuracy color - only if there are benchmark uncoded to calculate from
                                const accuracyColor = q.benchmark_uncoded > 0 ? 
                                    (q.classification_accuracy >= 0.8 ? 'var(--success-color)' : 
                                     (q.classification_accuracy >= 0.5 ? 'var(--warning-color)' : 'var(--danger-color)')) : 
                                    'var(--text-secondary)';
                                
                                const accuracyDisplay = q.benchmark_uncoded > 0 ? 
                                    `${(q.classification_accuracy * 100).toFixed(1)}%` : 
                                    'N/A';
                                
                                row.innerHTML = `
                                    <td style="font-weight: 500; color: var(--text-primary);">
                                        <strong>${q.question_id}</strong>
                                    </td>
                                    <td class="text-center" style="color: var(--text-secondary);">
                                        ${q.total_responses}
                                    </td>
                                    <td class="text-center">
                                        <span class="badge" style="background: rgba(242, 178, 102, 0.18); color: var(--warning-light); padding: 0.35rem 0.65rem; border: 1px solid rgba(242, 178, 102, 0.35); border-radius: 0.375rem; font-weight: 500;">
                                            ${q.benchmark_uncoded}
                                            <small>(${q.benchmark_uncoded_percentage.toFixed(1)}%)</small>
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge" style="background: rgba(241, 115, 115, 0.18); color: var(--danger-light); padding: 0.35rem 0.65rem; border: 1px solid rgba(241, 115, 115, 0.35); border-radius: 0.375rem; font-weight: 500;">
                                            ${q.model_uncoded}
                                            <small>(${q.model_uncoded_percentage.toFixed(1)}%)</small>
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge" style="background: rgba(16, 185, 129, 0.18); color: var(--success-light); padding: 0.35rem 0.65rem; border: 1px solid rgba(16, 185, 129, 0.35); border-radius: 0.375rem; font-weight: 500;">
                                            ${q.both_uncoded}
                                        </span>
                                    </td>
                                <td class="text-center" style="font-weight: 600; color: ${overlapPct >= 80 ? 'var(--success-light)' : (overlapPct < 50 && overlapPct > 0 ? 'var(--danger-light)' : 'var(--warning-light)')};">
                                    ${overlapPct.toFixed(1)}%
                                </td>
                                `;
                                
                                tableBody.appendChild(row);
                            });
                        } else {
                            // No uncoded responses found - show message and hide table
                            questionSection.style.display = 'block';
                            tableBody.innerHTML = '';
                            const noUncodedMsg = document.getElementById('noUncodedMessage');
                            if (noUncodedMsg) noUncodedMsg.style.display = 'block';
                        }
                    }
                } else {
                    const questionSection = document.getElementById('questionUncodedSection');
                    const noUncodedMsg = document.getElementById('noUncodedMessage');
                    if (questionSection) {
                        questionSection.style.display = 'none';
                    }
                    if (noUncodedMsg) {
                        noUncodedMsg.style.display = 'none';
                    }
                }

                // Display top/bottom codes
                if (data.top_codes && Array.isArray(data.top_codes)) {
                    displayCodeList('topCodes', data.top_codes);
                }
                if (data.bottom_codes && Array.isArray(data.bottom_codes)) {
                    displayCodeList('bottomCodes', data.bottom_codes);
                }

                // Show download section when results are available
                document.getElementById('downloadSection').style.display = 'block';
                
                // Get download button and enable/disable based on mismatches
                const downloadBtn = document.getElementById('downloadCsvBtn');
                if (!downloadBtn) {
                    console.error('[ERROR] Download button not found!');
                } else {
                    // Check multiple possible locations for mismatch data
                    const mismatchCount = data.mismatch_count || 
                                         (data.overall && data.overall.n_mismatches) || 
                                         0;
                    const hasMismatches = data.has_mismatches === true || 
                                         mismatchCount > 0 ||
                                         (data.overall && data.overall.n_mismatches > 0);
                    
                    console.log('[DEBUG] Download button state check:', {
                        has_mismatches: data.has_mismatches,
                        mismatch_count: data.mismatch_count,
                        n_mismatches: data.overall?.n_mismatches,
                        calculatedMismatchCount: mismatchCount,
                        calculatedHasMismatches: hasMismatches,
                        fullData: data
                    });
                    
                    if (hasMismatches && mismatchCount > 0) {
                        document.getElementById('mismatchSection').style.display = 'block';
                        document.getElementById('mismatchTitle').textContent = `Found ${mismatchCount} Mismatched Responses`;
                        document.getElementById('worstMismatches').innerHTML = `
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>${mismatchCount}</strong> mismatched responses found.
                                Click the button above to download the complete mismatch report with verbatim text and code details.
                            </div>
                        `;
                        // Enable download button
                        downloadBtn.removeAttribute('disabled');
                        downloadBtn.disabled = false;
                        downloadBtn.style.opacity = '1';
                        downloadBtn.style.cursor = 'pointer';
                        downloadBtn.classList.remove('disabled');
                        console.log('[DEBUG] ✅ Download button ENABLED - mismatches found:', mismatchCount);
                    } else {
                        document.getElementById('mismatchSection').style.display = 'none';
                        // Disable download button if no mismatches
                        downloadBtn.setAttribute('disabled', 'disabled');
                        downloadBtn.disabled = true;
                        downloadBtn.style.opacity = '0.5';
                        downloadBtn.style.cursor = 'not-allowed';
                        downloadBtn.classList.add('disabled');
                        console.log('[DEBUG] ❌ Download button DISABLED - no mismatches found. Count:', mismatchCount);
                    }
                }

                // Create charts (wrap in try-catch in case Chart.js fails)
                try {
                    createMetricsChart(results);
                } catch (chartError) {
                    console.error('[ERROR] Metrics chart creation failed:', chartError);
                }
                
                try {
                    createConfusionChart(results);
                } catch (chartError) {
                    console.error('[ERROR] Confusion chart creation failed:', chartError);
                }

                // Show results section
                const resultsSection = document.getElementById('resultsSection');
                resultsSection.style.display = 'block';
                resultsSection.classList.add('active');
                resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                console.log('[DEBUG] displayResults completed successfully');
            } catch (error) {
                console.error('[ERROR] Error in displayResults:', error);
                throw error;
            }
        }

        function updateMetric(elementId, value, labelId = null, isPercentage = false) {
            const element = document.getElementById(elementId);
            const displayValue = isPercentage ? (value * 100).toFixed(1) + '%' : value.toFixed(3);
            element.textContent = displayValue;

            // Color coding
            element.className = 'metric-value ';
            if (value >= 0.75) element.classList.add('metric-excellent');
            else if (value >= 0.60) element.classList.add('metric-good');
            else if (value >= 0.40) element.classList.add('metric-fair');
            else element.classList.add('metric-poor');

            if (labelId) {
                const label = document.getElementById(labelId);
                const originalText = label.getAttribute('data-original') || label.textContent;
                if (!label.getAttribute('data-original')) {
                    label.setAttribute('data-original', originalText);
                }
                
                let qualityText = '';
                if (value >= 0.75) qualityText = 'Excellent';
                else if (value >= 0.60) qualityText = 'Good';
                else if (value >= 0.40) qualityText = 'Fair';
                else qualityText = 'Needs Improvement';
                
                // Preserve the original indicator text (everything after the bullet)
                const parts = originalText.split(' • ');
                if (parts.length > 1) {
                    label.textContent = `${qualityText} • ${parts.slice(1).join(' • ')}`;
                } else {
                    label.textContent = qualityText;
                }
            }
        }

        function displayDeltaMetric(elementId, delta) {
            const element = document.getElementById(elementId);
            const displayValue = delta >= 0 ? `+${delta.toFixed(3)}` : delta.toFixed(3);
            element.textContent = displayValue;
            
            // Color coding for delta metrics
            element.className = 'metric-value ';
            // For delta metrics, positive is often good (except overlap)
            if (elementId === 'deltaOverlap') {
                // For overlap, lower is better (human - model), so negative delta is good
                if (delta <= -0.05) element.classList.add('metric-excellent');
                else if (delta <= 0) element.classList.add('metric-good');
                else if (delta <= 0.1) element.classList.add('metric-fair');
                else element.classList.add('metric-poor');
            } else {
                // For other deltas, positive is often good
                if (delta >= 0.1) element.classList.add('metric-excellent');
                else if (delta >= 0) element.classList.add('metric-good');
                else if (delta >= -0.1) element.classList.add('metric-fair');
                else element.classList.add('metric-poor');
            }
        }

        function displayCodeList(containerId, codes) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            codes.forEach((code, idx) => {
                const codeDiv = document.createElement('div');
                codeDiv.className = 'border-bottom pb-2 mb-2';
                codeDiv.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <small class="badge badge-depth-${code.depth} me-2">L${code.depth}</small>
                            <small class="text-muted">[${code.code}]</small>
                            <div class="mt-1"><strong>${code.description}</strong></div>
                        </div>
                        <div class="text-end">
                            <div class="badge ${code.f1 >= 0.7 ? 'bg-success' : code.f1 >= 0.5 ? 'bg-warning' : 'bg-danger'}">
                                F1: ${code.f1.toFixed(3)}
                            </div>
                            <div class="small text-muted mt-1">n=${code.support}</div>
                        </div>
                    </div>
                `;
                container.appendChild(codeDiv);
            });
        }

        function displayMismatches(mismatches, totalMismatches) {
            const container = document.getElementById('worstMismatches');
            const title = document.getElementById('mismatchTitle');
            container.innerHTML = '';
            title.textContent = `Top ${mismatches.length} Worst Mismatches (${totalMismatches} total)`;

            mismatches.forEach((mismatch, idx) => {
                const mismatchDiv = document.createElement('div');
                mismatchDiv.className = 'border-bottom pb-2 mb-3';
                
                // Compact header
                let html = `
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <div>
                            <span class="badge bg-secondary me-2">#${idx + 1}</span>
                            <small class="text-muted">R: ${mismatch.respondent_id} | Q: ${mismatch.question_id}</small>
                        </div>
                        <div>
                            <span class="badge bg-danger me-2">${mismatch.error_count} errors</span>
                            <small class="text-muted">J: ${mismatch.jaccard.toFixed(2)}</small>
                        </div>
                    </div>
                `;

                // Compact missed codes row - show code key and description
                if (mismatch.missed_codes && mismatch.missed_codes.length > 0) {
                    const missedItems = mismatch.missed_codes.map((code, i) => {
                        const desc = mismatch.missed_descriptions && mismatch.missed_descriptions[i] ? mismatch.missed_descriptions[i] : 'Unknown';
                        return `<span class="badge bg-danger me-2 mb-1"><strong>${code}</strong>: ${desc}</span>`;
                    }).join('');
                    html += `
                        <div class="mb-2">
                            <strong class="text-danger small me-2">❌ Missed:</strong>
                            <div class="d-flex flex-wrap gap-1 mt-1">
                                ${missedItems}
                            </div>
                        </div>
                    `;
                }

                // Compact extra codes row - show code key and description
                if (mismatch.extra_codes && mismatch.extra_codes.length > 0) {
                    const extraItems = mismatch.extra_codes.map((code, i) => {
                        const desc = mismatch.extra_descriptions && mismatch.extra_descriptions[i] ? mismatch.extra_descriptions[i] : 'Unknown';
                        return `<span class="badge bg-warning text-dark me-2 mb-1"><strong>${code}</strong>: ${desc}</span>`;
                    }).join('');
                    html += `
                        <div class="mb-2">
                            <strong class="text-warning small me-2">⚠️ Extra:</strong>
                            <div class="d-flex flex-wrap gap-1 mt-1">
                                ${extraItems}
                            </div>
                        </div>
                    `;
                }

                mismatchDiv.innerHTML = html;
                container.appendChild(mismatchDiv);
            });
        }

        // CSV Download Handler
        document.getElementById('downloadCsvBtn').addEventListener('click', async () => {
            const btn = document.getElementById('downloadCsvBtn');
            const statusDiv = document.getElementById('downloadStatus');
            const originalText = btn.innerHTML;
            
            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating CSV...';
                if (statusDiv) {
                    statusDiv.style.display = 'block';
                    statusDiv.innerHTML = '<i class="fas fa-clock me-1"></i>Generating CSV file...';
                    statusDiv.style.color = 'var(--text-secondary)';
                }
                
                console.log('[CSV] Starting download...');
                const response = await fetch('/api/download-mismatches');
                
                console.log('[CSV] Response status:', response.status);
                
                if (!response.ok) {
                    // Try to get detailed error message
                    let errorMsg = 'Download failed';
                    let suggestion = '';
                    try {
                        const data = await response.json();
                        errorMsg = data.error || errorMsg;
                        if (data.message) {
                            errorMsg += '\n\n' + data.message;
                        }
                        if (data.suggestion) {
                            suggestion = data.suggestion;
                        }
                    } catch (e) {
                        errorMsg = `Server error: ${response.status} ${response.statusText}`;
                    }
                    
                    // Show detailed error on page
                    showPageError(
                        'Download Error',
                        errorMsg,
                        suggestion || 'Please try again or check the browser console for details.'
                    );
                    console.error('[CSV] Download error details:', { errorMsg, suggestion });
                    return;
                }
                
                // Get filename from Content-Disposition header or use default
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'mismatches.csv';
                if (contentDisposition) {
                    const matches = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/.exec(contentDisposition);
                    if (matches && matches[1]) {
                        filename = matches[1].replace(/['"]/g, '');
                    }
                }
                
                console.log('[CSV] Downloading file:', filename);
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                console.log('[CSV] Download complete');
                if (statusDiv) {
                    statusDiv.innerHTML = '<i class="fas fa-check-circle me-1" style="color: var(--success-color);"></i>Download complete!';
                    statusDiv.style.color = 'var(--success-color)';
                    setTimeout(() => {
                        statusDiv.style.display = 'none';
                    }, 3000);
                }
                } catch (error) {
                    console.error('[CSV] Download error:', error);
                    if (statusDiv) {
                        statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-1" style="color: var(--danger-color);"></i>Download failed';
                        statusDiv.style.color = 'var(--danger-color)';
                    }
                    showPageError(
                        'Download Failed',
                        error.message || 'An unexpected error occurred during download.',
                        'Please try again or check the browser console for details.'
                    );
                } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });

        function createMetricsChart(results) {
            const ctx = document.getElementById('metricsChart');
            
            if (!ctx) {
                console.error('[ERROR] Metrics chart canvas element not found');
                return;
            }
            
            if (metricsChart) metricsChart.destroy();

            // Use coded_only metrics for consistency with displayed metrics
            // Fall back to overall metrics if coded_only is not available
            const codedOnly = results.coded_only || {};
            const f1Micro = codedOnly.f1_micro !== undefined ? codedOnly.f1_micro : (results.f1_micro !== undefined ? results.f1_micro : 0);
            const precisionMicro = codedOnly.precision_micro !== undefined ? codedOnly.precision_micro : (results.precision_micro !== undefined ? results.precision_micro : 0);
            const recallMicro = codedOnly.recall_micro !== undefined ? codedOnly.recall_micro : (results.recall_micro !== undefined ? results.recall_micro : 0);
            const jaccardMean = codedOnly.jaccard_mean !== undefined ? codedOnly.jaccard_mean : (results.jaccard_mean !== undefined ? results.jaccard_mean : 0);
            const exactMatchRatio = codedOnly.exact_match_ratio !== undefined ? codedOnly.exact_match_ratio : (results.exact_match_ratio !== undefined ? results.exact_match_ratio : 0);

            console.log('[DEBUG] Creating metrics chart with values:', {
                f1Micro, precisionMicro, recallMicro, jaccardMean, exactMatchRatio
            });

            metricsChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['F1 (Micro)', 'Precision', 'Recall', 'Jaccard', 'Exact Match'],
                    datasets: [{
                        label: 'Model Performance',
                        data: [
                            f1Micro,
                            precisionMicro,
                            recallMicro,
                            jaccardMean,
                            exactMatchRatio
                        ],
                        fill: true,
                        backgroundColor: 'rgba(59, 130, 246, 0.15)',
                        borderColor: 'rgb(59, 130, 246)',
                        pointBackgroundColor: 'rgb(59, 130, 246)',
                        pointBorderColor: 'rgba(26, 31, 53, 1)',
                        pointHoverBackgroundColor: 'rgb(96, 165, 250)',
                        pointHoverBorderColor: 'rgb(59, 130, 246)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 1,
                            ticks: {
                                stepSize: 0.2,
                                color: '#9ca3af',
                                backdropColor: 'transparent'
                            },
                            grid: {
                                color: 'rgba(42, 49, 72, 0.5)'
                            },
                            angleLines: {
                                color: 'rgba(42, 49, 72, 0.5)'
                            },
                            pointLabels: {
                                color: '#e5e7eb',
                                font: {
                                    size: 11
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
            
            console.log('[DEBUG] Metrics chart created successfully');
        }

        function createConfusionChart(results) {
            const ctx = document.getElementById('confusionChart');
            
            if (confusionChart) confusionChart.destroy();

            confusionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [
                        'True Positives\n(Correctly Coded)',
                        'False Positives\n(Extra Codes)',
                        'False Negatives\n(Missed Codes)'
                    ],
                    datasets: [{
                        label: 'Count',
                        data: [results.total_tp, results.total_fp, results.total_fn],
                        backgroundColor: [
                            'rgba(34, 197, 94, 0.5)',
                            'rgba(239, 68, 68, 0.5)',
                            'rgba(245, 158, 11, 0.5)'
                        ],
                        borderColor: [
                            'rgb(34, 197, 94)',
                            'rgb(239, 68, 68)',
                            'rgb(245, 158, 11)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#9ca3af'
                            },
                            grid: {
                                color: 'rgba(42, 49, 72, 0.5)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#e5e7eb',
                                font: {
                                    size: 11
                                }
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // ===== Single Hierarchy Metrics Tab =====
        let selectedSingleHierarchyFile = null;
        
        // Single Hierarchy File Upload
        const singleHierarchyUpload = document.getElementById('singleHierarchyUpload');
        const singleHierarchyInput = document.getElementById('singleHierarchyInput');
        const singleHierarchyInfo = document.getElementById('singleHierarchyInfo');
        const singleHierarchyFileName = document.getElementById('singleHierarchyFileName');
        const evaluateSingleHierarchyBtn = document.getElementById('evaluateSingleHierarchyBtn');
        
        if (singleHierarchyUpload && singleHierarchyInput) {
            singleHierarchyUpload.addEventListener('click', () => singleHierarchyInput.click());
            singleHierarchyUpload.addEventListener('dragover', (e) => {
                e.preventDefault();
                singleHierarchyUpload.style.borderColor = 'var(--primary-color)';
            });
            singleHierarchyUpload.addEventListener('dragleave', () => {
                singleHierarchyUpload.style.borderColor = 'var(--card-border)';
            });
            singleHierarchyUpload.addEventListener('drop', (e) => {
                e.preventDefault();
                singleHierarchyUpload.style.borderColor = 'var(--card-border)';
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].name.endsWith('.xml')) {
                    singleHierarchyInput.files = files;
                    handleSingleHierarchyFileSelect(files[0]);
                }
            });
            
            singleHierarchyInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleSingleHierarchyFileSelect(e.target.files[0]);
                }
            });
        }
        
        function handleSingleHierarchyFileSelect(file) {
            selectedSingleHierarchyFile = file;
            if (singleHierarchyFileName) singleHierarchyFileName.textContent = file.name;
            if (singleHierarchyInfo) singleHierarchyInfo.style.display = 'block';
            if (evaluateSingleHierarchyBtn) evaluateSingleHierarchyBtn.disabled = false;
        }
        
        // Single Hierarchy Evaluate Button
        if (evaluateSingleHierarchyBtn) {
            evaluateSingleHierarchyBtn.addEventListener('click', async () => {
                if (!selectedSingleHierarchyFile) return;
                
                const formData = new FormData();
                formData.append('file', selectedSingleHierarchyFile);
                
                // Show loading overlay
                const loadingOverlay = document.getElementById('loadingOverlay');
                const loadingTitle = document.getElementById('loadingTitle');
                const loadingMessage = document.getElementById('loadingMessage');
                
                loadingOverlay.classList.add('active');
                loadingTitle.textContent = 'Calculating Metrics...';
                loadingMessage.textContent = 'Computing semantic metrics for hierarchy. This may take 30-60 seconds.';
                
                try {
                    const response = await fetch('/api/evaluate-single-hierarchy', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok || data.error) {
                        showPageError(
                            data.error || 'Metrics Calculation Failed',
                            data.message || 'An error occurred during metrics calculation.',
                            data.suggestion || 'Please check your file and try again.'
                        );
                        loadingOverlay.classList.remove('active');
                        return;
                    }
                    
                    // Results are returned directly - no polling needed
                    loadingOverlay.classList.remove('active');
                    displaySingleHierarchyResults(data);
                    
                } catch (error) {
                    console.error('Error in evaluation request:', error);
                    showPageError(
                        'Metrics Calculation Failed',
                        error.message || 'An unexpected error occurred.',
                        'Please check your file and try again.'
                    );
                    loadingOverlay.classList.remove('active');
                }
            });
        }
        
        function displaySingleHierarchyResults(data) {
            console.log('Displaying results, data:', data);
            
            if (!data) {
                console.error('No data provided to displaySingleHierarchyResults');
                showPageError(
                    'No Results',
                    'No results data was received.',
                    'Please try again.'
                );
                return;
            }
            
            if (!data.success) {
                console.error('Results indicate failure. Data:', data);
                const errorMsg = data.error || 'The calculation did not complete successfully.';
                showPageError(
                    'Calculation Failed',
                    errorMsg,
                    'Please check your file and try again.'
                );
                return;
            }
            
            if (!data.metrics) {
                console.error('No metrics in results. Full data:', data);
                showPageError(
                    'No Metrics',
                    'Metrics were not computed. This might indicate an issue with the hierarchy structure.',
                    'Please check that your XML file has a valid hierarchy with codes and documents.'
                );
                return;
            }
            
            const metrics = data.metrics;
            console.log('Metrics to display:', metrics);
            console.log('Metrics keys:', Object.keys(metrics));
            
            function formatMetric(value) {
                if (value === undefined || value === null) return '-';
                return typeof value === 'number' ? value.toFixed(3) : value;
            }
            
            // Display metrics (with error handling for missing values)
            try {
                document.getElementById('singleEmbeddingCoherence').textContent = formatMetric(metrics.embedding_coherence);
                document.getElementById('singleParentChildSimilarity').textContent = formatMetric(metrics.parent_child_similarity);
                document.getElementById('singleLocalDuplicatePenalty').textContent = formatMetric(metrics.local_duplicate_penalty);
                document.getElementById('singleGlobalDuplicatePenalty').textContent = formatMetric(metrics.global_duplicate_penalty);
                document.getElementById('singleIntraLevelDiversity').textContent = formatMetric(metrics.intra_level_diversity);
                document.getElementById('singleInterLevelGranularity').textContent = formatMetric(metrics.inter_level_granularity);
                document.getElementById('singleNetPurity').textContent = formatMetric(metrics.net_purity);
                document.getElementById('singleCompositeQualityScore').textContent = formatMetric(metrics.composite_quality_score);
            } catch (metricError) {
                console.error('Error displaying metrics:', metricError);
                console.error('Metrics object:', metrics);
            }
            
            // Display statistics
            try {
                document.getElementById('singleTotalCodes').textContent = metrics.total_codes || '-';
                document.getElementById('singleMaxDepth').textContent = metrics.max_depth || '-';
                document.getElementById('singleCodesWithDocuments').textContent = metrics.codes_with_documents || '-';
            } catch (statError) {
                console.error('Error displaying statistics:', statError);
            }
            
            // Display coverage statistics if available
            try {
                if (metrics.coverage_stats) {
                    const cov = metrics.coverage_stats;
                    const coverageSection = document.getElementById('coverageStatsSection');
                    
                    if (coverageSection) {
                        const descEl = document.getElementById('coverageDescriptions');
                        const docsEl = document.getElementById('coverageDocuments');
                        const cohEl = document.getElementById('coverageCoherence');
                        const pcEl = document.getElementById('coverageParentChild');
                        const npEl = document.getElementById('coverageNetPurity');
                        const sdEl = document.getElementById('coverageSingleDoc');
                        
                        if (descEl) descEl.textContent = 
                            `${cov.codes_with_descriptions || 0} / ${cov.total_codes || 0} (${formatMetric((cov.description_coverage || 0) * 100)}%)`;
                        if (docsEl) docsEl.textContent = 
                            `${cov.codes_with_documents || 0} / ${cov.total_codes || 0} (${formatMetric((cov.document_coverage || 0) * 100)}%)`;
                        if (cohEl) cohEl.textContent = 
                            `${formatMetric((cov.coherence_coverage || 0) * 100)}%`;
                        if (pcEl) pcEl.textContent = 
                            `${formatMetric((cov.parent_child_coverage || 0) * 100)}%`;
                        if (npEl) npEl.textContent = 
                            `${formatMetric((cov.net_purity_coverage || 0) * 100)}%`;
                        if (sdEl) sdEl.textContent = 
                            `${cov.single_document_codes || 0} codes`;
                        
                        // Show coverage section
                        coverageSection.style.display = 'block';
                    }
                }
            } catch (covError) {
                console.error('Error displaying coverage stats:', covError);
            }
            
            // Display tree
            try {
                if (data.tree) {
                    displayTree('singleHierarchyTree', data.tree);
                }
            } catch (treeError) {
                console.error('Error displaying tree:', treeError);
            }
            
            // Ensure tab is active and show results section
            try {
                // Activate the single hierarchy tab if not already active
                const singleHierarchyTab = document.getElementById('singleHierarchyTab');
                const singleHierarchyPane = document.getElementById('singleHierarchy');
                
                if (singleHierarchyTab && singleHierarchyPane) {
                    // Remove active state from all tabs
                    document.querySelectorAll('.nav-link').forEach(link => {
                        link.classList.remove('active');
                        link.setAttribute('aria-selected', 'false');
                    });
                    document.querySelectorAll('.tab-pane').forEach(pane => {
                        pane.classList.remove('show', 'active');
                    });
                    
                    // Activate single hierarchy tab
                    singleHierarchyTab.classList.add('active');
                    singleHierarchyTab.setAttribute('aria-selected', 'true');
                    singleHierarchyPane.classList.add('show', 'active');
                }
                
                // Show results section
                const resultsSection = document.getElementById('singleHierarchyResultsSection');
                if (resultsSection) {
                    resultsSection.style.display = 'block';
                    
                    // Scroll to results after tab is visible
                    setTimeout(() => {
                        resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        console.log('Results section displayed successfully');
                    }, 100);
                } else {
                    console.error('Results section element not found!');
                    showPageError(
                        'Display Error',
                        'Results section not found in page.',
                        'Please refresh the page and try again.'
                    );
                }
            } catch (displayError) {
                console.error('Error showing results section:', displayError);
                // Try to show results section anyway
                const resultsSection = document.getElementById('singleHierarchyResultsSection');
                if (resultsSection) {
                    resultsSection.style.display = 'block';
                }
            }
        }

        // ===== Hierarchy Comparison Tab =====
        let benchmarkHierarchyFile = null;
        let modelHierarchyFile = null;

        // Benchmark hierarchy upload
        const benchmarkHierarchyUpload = document.getElementById('benchmarkHierarchyUpload');
        const benchmarkHierarchyInput = document.getElementById('benchmarkHierarchyInput');
        const benchmarkHierarchyInfo = document.getElementById('benchmarkHierarchyInfo');
        const benchmarkHierarchyFileName = document.getElementById('benchmarkHierarchyFileName');

        benchmarkHierarchyUpload.addEventListener('click', () => benchmarkHierarchyInput.click());
        benchmarkHierarchyInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                benchmarkHierarchyFile = e.target.files[0];
                benchmarkHierarchyFileName.textContent = benchmarkHierarchyFile.name;
                benchmarkHierarchyInfo.style.display = 'block';
                checkHierarchyReady();
            }
        });

        // Model hierarchy upload
        const modelHierarchyUpload = document.getElementById('modelHierarchyUpload');
        const modelHierarchyInput = document.getElementById('modelHierarchyInput');
        const modelHierarchyInfo = document.getElementById('modelHierarchyInfo');
        const modelHierarchyFileName = document.getElementById('modelHierarchyFileName');

        modelHierarchyUpload.addEventListener('click', () => modelHierarchyInput.click());
        modelHierarchyInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                modelHierarchyFile = e.target.files[0];
                modelHierarchyFileName.textContent = modelHierarchyFile.name;
                modelHierarchyInfo.style.display = 'block';
                checkHierarchyReady();
            }
        });

        function checkHierarchyReady() {
            const btn = document.getElementById('evaluateHierarchyBtn');
            btn.disabled = !(benchmarkHierarchyFile && modelHierarchyFile);
        }

        // Evaluate hierarchy (simple comparison - no metrics)
        document.getElementById('evaluateHierarchyBtn').addEventListener('click', async () => {
            if (!benchmarkHierarchyFile || !modelHierarchyFile) return;

            const formData = new FormData();
            formData.append('benchmark_file', benchmarkHierarchyFile);
            formData.append('model_file', modelHierarchyFile);

            // Show loading overlay (simple spinner)
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingTitle = document.getElementById('loadingTitle');
            const loadingMessage = document.getElementById('loadingMessage');
            
            loadingOverlay.classList.add('active');
            loadingTitle.textContent = 'Comparing Hierarchies...';
            loadingMessage.textContent = 'Extracting hierarchy structures';

            try {
                const response = await fetch('/api/compare-hierarchy', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok || data.error) {
                    showPageError(
                        data.error || 'Hierarchy Comparison Failed',
                        data.message || 'An error occurred during hierarchy comparison.',
                        data.suggestion || 'Please check your files and try again.'
                    );
                    loadingOverlay.classList.remove('active');
                    return;
                }

                // Display results immediately (no progress polling needed)
                loadingOverlay.classList.remove('active');
                displayHierarchyComparison(data);
                
            } catch (error) {
                showPageError(
                    'Hierarchy Comparison Failed',
                    error.message || 'An unexpected error occurred.',
                    'Please check your files and try again.'
                );
                loadingOverlay.classList.remove('active');
            }
        });

        function displayHierarchyComparison(data) {
            if (!data.success) {
                showPageError(
                    'Invalid Results',
                    'The comparison data is invalid or incomplete.',
                    'Please try again.'
                );
                return;
            }
            
            // Display trees side-by-side
            if (data.benchmark && data.benchmark.tree) {
                displayTree('benchmarkTree', data.benchmark.tree);
            }
            if (data.model && data.model.tree) {
                displayTree('modelTree', data.model.tree);
            }

            // Show results section
            const resultsSection = document.getElementById('hierarchyResultsSection');
            resultsSection.style.display = 'block';
            resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function displayStats(containerId, stats) {
            const container = document.getElementById(containerId);
            const formatValue = (val) => val !== undefined && val !== null ? val.toFixed(3) : 'N/A';
            const getCoherenceColor = (val) => val >= 0.75 ? 'text-success' : val >= 0.5 ? 'text-warning' : 'text-danger';
            const getPenaltyColor = (val) => val <= 0.10 ? 'text-success' : val <= 0.3 ? 'text-warning' : 'text-danger';
            
            container.innerHTML = `
                <div class="mb-3">
                    <h5 class="mb-3">Structural Stats</h5>
                    <div class="mb-2"><strong>Total Codes:</strong> ${stats.total_nodes || 0}</div>
                    <div class="mb-2"><strong>Max Depth:</strong> ${stats.max_depth || 0}</div>
                    <div class="mb-2"><strong>Codes with Documents:</strong> ${stats.codes_with_documents || 0}</div>
                </div>
                ${stats.coherence !== undefined ? `
                    <div class="mt-3 pt-3 border-top" style="border-color: var(--card-border);">
                        <h5 class="mb-3">Semantic Metrics</h5>
                        <div class="mb-2">
                            <strong>Embedding Coherence:</strong> 
                            <span class="${getCoherenceColor(stats.coherence)}">${formatValue(stats.coherence)}</span>
                            <small class="text-muted ms-2">(≥0.75 good)</small>
                        </div>
                        ${stats.parent_child_similarity !== undefined ? `
                            <div class="mb-2">
                                <strong>Parent–Child Similarity:</strong> 
                                <span>${formatValue(stats.parent_child_similarity)}</span>
                            </div>
                        ` : ''}
                        ${stats.local_duplicate_penalty !== undefined ? `
                            <div class="mb-2">
                                <strong>Local Duplicate Penalty:</strong> 
                                <span class="${getPenaltyColor(stats.local_duplicate_penalty)}">${formatValue(stats.local_duplicate_penalty)}</span>
                                <small class="text-muted ms-2">(≤0.10 good)</small>
                            </div>
                        ` : ''}
                        ${stats.global_duplicate_penalty !== undefined ? `
                            <div class="mb-2">
                                <strong>Global Duplicate Penalty:</strong> 
                                <span class="${getPenaltyColor(stats.global_duplicate_penalty)}">${formatValue(stats.global_duplicate_penalty)}</span>
                                <small class="text-muted ms-2">(≤0.15 good)</small>
                            </div>
                        ` : ''}
                        ${stats.intra_level_diversity !== undefined ? `
                            <div class="mb-2">
                                <strong>Intra-Level Diversity:</strong> 
                                <span>${formatValue(stats.intra_level_diversity)}</span>
                            </div>
                        ` : ''}
                        ${stats.inter_level_granularity !== undefined ? `
                            <div class="mb-2">
                                <strong>Inter-Level Granularity:</strong> 
                                <span>${formatValue(stats.inter_level_granularity)}</span>
                            </div>
                        ` : ''}
                        ${stats.net_purity !== undefined ? `
                            <div class="mb-2">
                                <strong>Net Purity:</strong> 
                                <span>${formatValue(stats.net_purity)}</span>
                            </div>
                        ` : ''}
                        ${stats.composite_quality_score !== undefined ? `
                            <div class="mb-2 mt-3 pt-3 border-top" style="border-color: var(--card-border);">
                                <strong>Composite Quality Score:</strong> 
                                <span class="text-primary" style="font-size: 1.1rem; font-weight: 600;">${formatValue(stats.composite_quality_score)}</span>
                                <small class="text-muted ms-2">(0-1 scale)</small>
                            </div>
                        ` : ''}
                    </div>
                ` : ''}
            `;
        }

        // Helper function to update progress status with animation
        
        function displayTree(containerId, tree) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = '';
            
            function renderNode(node, level = 0) {
                const indent = level * 20;
                const isNet = node.is_net || false;
                const nodeClass = isNet ? 'text-primary' : 'text-secondary';
                const icon = isNet ? 'fa-folder' : 'fa-file';
                
                const nodeDiv = document.createElement('div');
                nodeDiv.className = 'mb-2';
                nodeDiv.style.paddingLeft = `${indent}px`;
                nodeDiv.innerHTML = `
                    <div class="d-flex align-items-center ${nodeClass}">
                        <i class="fas ${icon} me-2"></i>
                        <span class="badge badge-depth-${node.depth} me-2">L${node.depth}</span>
                        <strong>${node.key}</strong>
                        <span class="ms-2 text-muted">${node.description || ''}</span>
                    </div>
                `;
                container.appendChild(nodeDiv);
                
                if (node.children && node.children.length > 0) {
                    node.children.forEach(child => renderNode(child, level + 1));
                }
            }
            
            renderNode(tree);
        }

        // Tab switching styling
        document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
            tab.addEventListener('shown.bs.tab', function (e) {
                // Update active tab styling
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.style.color = 'var(--text-secondary)';
                    link.style.borderBottom = 'none';
                });
                e.target.style.color = 'var(--text-primary)';
                e.target.style.borderBottom = '2px solid var(--primary-color)';
            });
        });
        
        // Set initial active tab styling
        document.querySelector('.nav-link.active').style.color = 'var(--text-primary)';
        document.querySelector('.nav-link.active').style.borderBottom = '2px solid var(--primary-color)';
    </script>
</body>
</html>

